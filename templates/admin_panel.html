<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Chat Control</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* ğŸš¨ NEW FUNKY POP ADMIN THEME */
        :root { 
            --primary-color: #FF0066;      /* Hot Pink/Magenta */
            --secondary-color: #00FFCC;    /* Bright Cyan/Turquoise */
            --background-color: #FFEBEB;   /* Very Pale Pink Background */
            --box-bg: #FFFFFF;             /* White/Light Box Background */
            --border-color: #FF77A9;       /* Medium Pink Border */
            --text-color: #333333;
            --button-color: #FFCC00;      /* Yellow/Gold Accent */
            --shadow-admin: 0 8px 15px rgba(255, 0, 102, 0.4);
            --shadow-success: 0 4px 8px rgba(0, 255, 204, 0.3);
            --shadow-error: 0 4px 8px rgba(255, 0, 102, 0.6);
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .admin-container {
            width: 100%;
            max-width: 1200px;
            background: var(--box-bg);
            border-radius: 15px;
            box-shadow: var(--shadow-admin);
            padding: 20px 30px;
            margin-top: 20px;
        }

        header {
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        header h1 {
            color: var(--primary-color);
            font-weight: 900;
        }

        .user-info {
            font-size: 1.1em;
            font-weight: 700;
        }

        .user-info .role {
            color: var(--secondary-color);
            background-color: var(--primary-color);
            padding: 5px 10px;
            border-radius: 5px;
            margin-left: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .tab-menu {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-button {
            background: none;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 700;
            color: var(--text-color);
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab-button:hover:not(.active) {
            color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Form & List Styling */
        .form-group, .list-item {
            margin-bottom: 15px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        input[type="text"], input[type="url"], input[type="number"], select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1em;
        }

        button {
            background-color: var(--button-color);
            color: var(--text-color);
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 700;
            transition: background-color 0.2s, box-shadow 0.2s;
        }

        button.action-button {
            background-color: var(--primary-color);
            color: white;
            margin-left: 10px;
        }
        
        button.action-button.delete {
            background-color: #e74c3c; /* Red */
        }
        
        button.action-button.unban {
            background-color: #2ecc71; /* Green */
        }

        button.action-button:hover {
            box-shadow: 0 4px 8px rgba(255, 0, 102, 0.4);
        }

        #message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .setting-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* List Specifics */
        .users-list, .emoticons-list {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 15px;
        }
        
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .list-item:hover {
            background-color: #ffe0e9;
        }

        .user-details, .emoticon-details {
            flex-grow: 1;
        }
        
        .user-details strong {
            color: var(--primary-color);
        }
        
        .emoticon-details strong {
            color: var(--secondary-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-container {
                padding: 15px;
            }
            header {
                flex-direction: column;
                align-items: flex-start;
            }
            .user-info {
                margin-top: 10px;
            }
            .list-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .list-item .actions {
                margin-top: 10px;
                width: 100%;
                display: flex;
                justify-content: flex-end;
            }
            .list-item select, .list-item button {
                margin-top: 5px;
            }
        }
    </style>
</head>

<body>
    <!-- ğŸš¨ ÎšÎ¡Î™Î£Î™ÎœÎŸ FIX: Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Jinja templates Î³Î¹Î± Ï„Î¿Ï…Ï‚ URLs Î³Î¹Î± Î±Ï€Î¿Ï†Ï…Î³Î® ÏƒÏ†Î±Î»Î¼Î¬Ï„Ï‰Î½ 'Failed to parse URL' -->
    <script>
        const CHECK_LOGIN_URL = "{{ url_for('check_login') }}";
        const LOGIN_URL = "{{ url_for('login') }}";
        const CHAT_URL = "{{ url_for('index') }}";
        
        // API URLs Î³Î¹Î± ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚
        const GET_SETTINGS_URL = "{{ url_for('api_get_settings') }}";
        const UPDATE_SETTING_BASE_URL = "{{ url_for('api_update_setting', setting_key='PLACEHOLDER') }}".replace('PLACEHOLDER', '');
        
        // API URLs Î³Î¹Î± emoticons
        const GET_EMOTICONS_URL = "{{ url_for('api_get_emoticons') }}";
        const ADD_EMOTICON_URL = "{{ url_for('api_add_emoticon') }}";
        const DELETE_EMOTICON_BASE_URL = "{{ url_for('api_delete_emoticon', emoticon_id=0) }}".replace('/0', '');
        
        // API URLs Î³Î¹Î± Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚
        const GET_USERS_URL = "{{ url_for('api_get_users') }}";
        const UPDATE_USER_ROLE_BASE_URL = "{{ url_for('api_update_user_role', user_id=0) }}".replace('/0/role', ''); // ÎšÏÎ±Ï„Î¬Î¼Îµ Ï„Î¿ ID Î³Î¹Î± Ï‡ÏÎ®ÏƒÎ· ÏƒÏ„Î· ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ·
        const DELETE_USER_BASE_URL = "{{ url_for('api_delete_user', user_id=0) }}".replace('/0', '');
        const UNBAN_USER_BASE_URL = "{{ url_for('api_unban_user', user_id=0) }}".replace('/0/unban', '');
    </script>
    
    <div class="admin-container">
        <header>
            <h1><i class="fas fa-tools"></i> Î Î¯Î½Î±ÎºÎ±Ï‚ Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·Ï‚ Chat</h1>
            <div class="user-info">
                ÎŸ ÏÏŒÎ»Î¿Ï‚ Î¼Î¿Ï…: <span class="role" id="current_user_role">...</span>
            </div>
        </header>

        <!-- Tab Menu -->
        <div class="tab-menu">
            <button class="tab-button active" onclick="showTab('settings')">Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</button>
            <button class="tab-button" onclick="showTab('emoticons')">Emoticons</button>
            <button class="tab-button" onclick="showTab('users')">Î§ÏÎ®ÏƒÏ„ÎµÏ‚</button>
            <button class="tab-button" onclick="window.location.href = CHAT_URL;"><i class="fas fa-comments"></i> Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î¿ Chat</button>
        </div>

        <!-- Tab Content: Settings -->
        <div id="settings" class="tab-content active">
            <h2><i class="fas fa-sliders-h"></i> Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Chat</h2>
            <div id="settings-list">
                <!-- Settings will be dynamically loaded here -->
            </div>
            <div id="settings-message" class="message"></div>
        </div>

        <!-- Tab Content: Emoticons -->
        <div id="emoticons" class="tab-content">
            <h2><i class="fas fa-smile"></i> Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Emoticons</h2>
            
            <div class="form-group">
                <h3>Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÎÎ­Î¿Ï… Emoticon</h3>
                <label for="new-code">ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ Emoticon (Ï€.Ï‡. :cool:):</label>
                <input type="text" id="new-code" placeholder=":code:" required>
                
                <label for="new-url">URL Î•Î¹ÎºÏŒÎ½Î±Ï‚/GIF:</label>
                <input type="url" id="new-url" placeholder="http://example.com/image.gif" required>
                
                <button onclick="addEmoticon()"><i class="fas fa-plus"></i> Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
                <div id="emoticon-add-message" class="message"></div>
            </div>

            <h3>Î›Î¯ÏƒÏ„Î± Emoticons</h3>
            <div class="emoticons-list" id="emoticons-list">
                <!-- Emoticons will be dynamically loaded here -->
            </div>
            <div id="emoticon-message" class="message"></div>
        </div>

        <!-- Tab Content: Users -->
        <div id="users" class="tab-content">
            <h2><i class="fas fa-users"></i> Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î§ÏÎ·ÏƒÏ„ÏÎ½</h2>
            <p><strong>Î Î¡ÎŸÎ£ÎŸÎ§Î—:</strong> Î— Î±Î»Î»Î±Î³Î® ÏÏŒÎ»Î¿Ï… Î® Î· Î´Î¹Î±Î³ÏÎ±Ï†Î® Ï‡ÏÎ®ÏƒÏ„Î· ÎµÎ¯Î½Î±Î¹ Î¼Î· Î±Î½Î±ÏƒÏ„ÏÎ­ÏˆÎ¹Î¼Î·.</p>
            <div class="users-list" id="users-list">
                <!-- Users will be dynamically loaded here -->
            </div>
            <div id="users-message" class="message"></div>
        </div>
    </div>

    <script>
        // Global State
        let currentUserId = null;
        let currentUserRole = null;
        const adminMessage = document.getElementById('message');

        // Utility: Display System Message
        function showMessage(elementId, text, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = text;
            element.style.color = isError ? '#e74c3c' : '#2ecc71';
            setTimeout(() => {
                element.textContent = '';
            }, 5000);
        }

        // Utility: Tab Switching
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-button[onclick*='${tabId}']`).classList.add('active');
        }

        // ----------------------------------------------------
        // 1. Î¡Î¥Î˜ÎœÎ™Î£Î•Î™Î£ (Settings)
        // ----------------------------------------------------

        async function loadSettings() {
            try {
                const response = await fetch(GET_SETTINGS_URL);
                if (!response.ok) throw new Error('Failed to load settings.');
                
                const settings = await response.json();
                const list = document.getElementById('settings-list');
                list.innerHTML = '';

                settings.forEach(setting => {
                    const item = document.createElement('div');
                    item.className = 'form-group setting-toggle';
                    item.innerHTML = `
                        <div>
                            <strong>${setting.display_name}</strong>
                            <p>${setting.description}</p>
                        </div>
                        <select id="setting-${setting.key}" data-key="${setting.key}" onchange="updateSetting('${setting.key}', this.value)">
                            <option value="True" ${setting.value === 'True' ? 'selected' : ''}>Î•Î½ÎµÏÎ³ÏŒ</option>
                            <option value="False" ${setting.value === 'False' ? 'selected' : ''}>Î‘Î½ÎµÎ½ÎµÏÎ³ÏŒ</option>
                        </select>
                    `;
                    list.appendChild(item);
                });

            } catch (error) {
                console.error('Error loading settings:', error);
                showMessage('settings-message', 'Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÏ‰Î½.', true);
            }
        }

        async function updateSetting(key, value) {
            // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¿ÏÎ¼Îµ Ï„Î¿ ÏƒÏ‰ÏƒÏ„ÏŒ URL Î¼Îµ Ï„Î¿Î½ key
            const url = UPDATE_SETTING_BASE_URL + key;

            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ value: value })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('settings-message', `Î— ÏÏÎ¸Î¼Î¹ÏƒÎ· ${key} ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ.`, false);
                } else {
                    throw new Error(result.error || 'Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·Ï‚ ÏÏÎ¸Î¼Î¹ÏƒÎ·Ï‚.');
                }
            } catch (error) {
                console.error(`Error updating setting ${key}:`, error);
                showMessage('settings-message', error.message, true);
            }
        }

        // ----------------------------------------------------
        // 2. EMOTICONS
        // ----------------------------------------------------
        
        async function loadEmoticons() {
            try {
                const response = await fetch(GET_EMOTICONS_URL);
                if (!response.ok) throw new Error('Failed to load emoticons.');
                
                const emoticons = await response.json();
                const list = document.getElementById('emoticons-list');
                list.innerHTML = '';

                emoticons.forEach(emoticon => {
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    item.id = `emoticon-item-${emoticon.id}`;
                    item.innerHTML = `
                        <div class="emoticon-details">
                            <strong>${emoticon.code}</strong> 
                            (ID: ${emoticon.id})
                            <img src="${emoticon.url}" alt="${emoticon.code}" style="width: 30px; height: 30px; margin-left: 10px; border-radius: 3px; vertical-align: middle;">
                        </div>
                        <div class="actions">
                            <button class="action-button delete" onclick="deleteEmoticon(${emoticon.id})">
                                <i class="fas fa-trash"></i> Î”Î¹Î±Î³ÏÎ±Ï†Î®
                            </button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading emoticons:', error);
                showMessage('emoticon-message', 'Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ emoticons.', true);
            }
        }

        async function addEmoticon() {
            const codeInput = document.getElementById('new-code').value.trim();
            const urlInput = document.getElementById('new-url').value.trim();

            if (!codeInput || !urlInput) {
                showMessage('emoticon-add-message', 'Î Î±ÏÎ±ÎºÎ±Î»Ï ÏƒÏ…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ ÎºÎ±Î¹ Ï„Î± Î´ÏÎ¿ Ï€ÎµÎ´Î¯Î±.', true);
                return;
            }

            try {
                const response = await fetch(ADD_EMOTICON_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: codeInput, url: urlInput })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('emoticon-add-message', result.message || 'Emoticon Ï€ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚.', false);
                    document.getElementById('new-code').value = '';
                    document.getElementById('new-url').value = '';
                    await loadEmoticons(); // Reload list
                } else {
                    throw new Error(result.error || 'Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎ·Ï‚ Emoticon.');
                }
            } catch (error) {
                console.error('Error adding emoticon:', error);
                showMessage('emoticon-add-message', error.message, true);
            }
        }

        async function deleteEmoticon(id) {
            // Î‘Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· alert() Î¼Îµ custom UI
            if (!confirm(`Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Ï„Î¿ Emoticon Î¼Îµ ID ${id};`)) return;

            // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¿ÏÎ¼Îµ Ï„Î¿ ÏƒÏ‰ÏƒÏ„ÏŒ URL Î¼Îµ Ï„Î¿ ID
            const url = DELETE_EMOTICON_BASE_URL + '/' + id;

            try {
                const response = await fetch(url, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('emoticon-message', result.message || `Emoticon ${id} Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ.`, false);
                    document.getElementById(`emoticon-item-${id}`).remove();
                } else {
                    throw new Error(result.error || 'Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î´Î¹Î±Î³ÏÎ±Ï†Î®Ï‚ Emoticon.');
                }
            } catch (error) {
                console.error(`Error deleting emoticon ${id}:`, error);
                showMessage('emoticon-message', error.message, true);
            }
        }

        // ----------------------------------------------------
        // 3. Î§Î¡Î—Î£Î¤Î•Î£ (Users)
        // ----------------------------------------------------

        async function loadUsers() {
            try {
                const response = await fetch(GET_USERS_URL);
                if (!response.ok) throw new Error('Failed to load users.');
                
                const users = await response.json();
                const list = document.getElementById('users-list');
                list.innerHTML = '';
                const roles = ['user', 'moderator', 'admin', 'owner', 'banned'];

                users.forEach(user => {
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    item.id = `user-item-${user.id}`;
                    item.innerHTML = `
                        <div class="user-details">
                            <img src="${user.avatar_url}" alt="${user.display_name}" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; vertical-align: middle;">
                            <strong>${user.display_name}</strong> 
                            (${user.email}) - ID: ${user.id} - 
                            <span style="color: ${user.is_banned ? 'red' : 'green'}; font-weight: bold;">${user.is_banned ? 'BANNED' : 'ACTIVE'}</span>
                        </div>
                        <div class="actions">
                            ${user.id !== currentUserId ? `
                            <select id="role-select-${user.id}" onchange="updateUserRole(${user.id}, this.value)" ${user.role === 'owner' ? 'disabled' : ''}>
                                ${roles.map(role => `
                                    <option value="${role}" ${user.role === role ? 'selected' : ''} ${role === 'owner' && currentUserRole !== 'owner' ? 'disabled' : ''}>
                                        ${role.toUpperCase()}
                                    </option>
                                `).join('')}
                            </select>
                            ` : `<span style="margin-right: 15px;">(Your Role)</span>`}

                            ${(currentUserRole === 'owner' || currentUserRole === 'admin') && user.role !== 'owner' && user.id !== currentUserId ? `
                                <button class="action-button delete" onclick="deleteUser(${user.id})">
                                    <i class="fas fa-user-minus"></i> Î”Î¹Î±Î³ÏÎ±Ï†Î®
                                </button>
                                ${user.is_banned ? `
                                <button class="action-button unban" onclick="unbanUser(${user.id})">
                                    <i class="fas fa-check-circle"></i> Unban
                                </button>
                                ` : ''}
                            ` : ''}
                        </div>
                    `;
                    list.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading users:', error);
                showMessage('users-message', 'Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Ï‡ÏÎ·ÏƒÏ„ÏÎ½.', true);
            }
        }

        async function updateUserRole(id, role) {
            if (role === 'owner' && currentUserRole !== 'owner') {
                 showMessage('users-message', 'ÎœÏŒÎ½Î¿ Î¿ Owner Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î¿ÏÎ¯ÏƒÎµÎ¹ Î¬Î»Î»Î¿Î½ Ï‰Ï‚ Owner.', true);
                 document.getElementById(`role-select-${id}`).value = 'admin'; // Revert selection if possible
                 return;
            }

            if (id === currentUserId && role !== currentUserRole) {
                 showMessage('users-message', 'Î”ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î±Î»Î»Î¬Î¾ÎµÏ„Îµ Ï„Î¿Î½ Î´Î¹ÎºÏŒ ÏƒÎ±Ï‚ ÏÏŒÎ»Î¿.', true);
                 document.getElementById(`role-select-${id}`).value = currentUserRole; // Revert selection
                 return;
            }

            if (!confirm(`Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î±Î»Î»Î¬Î¾ÎµÏ„Îµ Ï„Î¿Î½ ÏÏŒÎ»Î¿ Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î· ${id} ÏƒÎµ ${role.toUpperCase()};`)) {
                 document.getElementById(`role-select-${id}`).value = document.querySelector(`#user-item-${id} .user-details span`).textContent.toLowerCase().replace(/[()]/g, ''); // Revert to current displayed role
                 return;
            }
            
            // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¿ÏÎ¼Îµ Ï„Î¿ ÏƒÏ‰ÏƒÏ„ÏŒ URL Î¼Îµ Ï„Î¿ ID
            const url = UPDATE_USER_ROLE_BASE_URL + '/' + id + '/role';
            
            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: role })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('users-message', result.message || `ÎŸ ÏÏŒÎ»Î¿Ï‚ Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î· ${id} Î¬Î»Î»Î±Î¾Îµ ÏƒÎµ ${role.toUpperCase()}.`, false);
                    await loadUsers(); // Reload list to reflect changes
                } else {
                    throw new Error(result.error || 'Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·Ï‚ ÏÏŒÎ»Î¿Ï….');
                }
            } catch (error) {
                console.error(`Error updating user role ${id}:`, error);
                showMessage('users-message', error.message, true);
            }
        }
        
        async function deleteUser(id) {
            // Î‘Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· alert() Î¼Îµ custom UI
            if (!confirm(`Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î”Î™Î‘Î“Î¡Î‘Î¨Î•Î¤Î• Î¿ÏÎ¹ÏƒÏ„Î¹ÎºÎ¬ Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î· Î¼Îµ ID ${id};`)) return;

            // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¿ÏÎ¼Îµ Ï„Î¿ ÏƒÏ‰ÏƒÏ„ÏŒ URL Î¼Îµ Ï„Î¿ ID
            const url = DELETE_USER_BASE_URL + '/' + id;

            try {
                const response = await fetch(url, { method: 'DELETE' });
                const result = await response.json();

                if (response.ok) {
                    showMessage('users-message', result.message || `ÎŸ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ ${id} Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ.`, false);
                    document.getElementById(`user-item-${id}`).remove();
                } else {
                    throw new Error(result.error || 'Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î´Î¹Î±Î³ÏÎ±Ï†Î®Ï‚ Ï‡ÏÎ®ÏƒÏ„Î·.');
                }
            } catch (error) {
                console.error(`Error deleting user ${id}:`, error);
                showMessage('users-message', error.message, true);
            }
        }
        
        async function unbanUser(id) {
            // Î‘Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· alert() Î¼Îµ custom UI
            if (!confirm(`Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î¬ÏÎµÏ„Îµ Ï„Î·Î½ Î±Ï€Î±Î³ÏŒÏÎµÏ…ÏƒÎ· (unban) Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î· Î¼Îµ ID ${id};`)) return;

            // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¿ÏÎ¼Îµ Ï„Î¿ ÏƒÏ‰ÏƒÏ„ÏŒ URL Î¼Îµ Ï„Î¿ ID
            const url = UNBAN_USER_BASE_URL + '/' + id + '/unban';

            try {
                const response = await fetch(url, { method: 'PUT' });
                const result = await response.json();

                if (response.ok) {
                    showMessage('users-message', result.message || `ÎŸ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ ${id} Î­Î³Î¹Î½Îµ Unbanned.`, false);
                    await loadUsers(); // Reload list to reflect changes
                } else {
                    throw new Error(result.error || 'Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Unban Ï‡ÏÎ®ÏƒÏ„Î·.');
                }
            } catch (error) {
                console.error(`Error unbanning user ${id}:`, error);
                showMessage('users-message', error.message, true);
            }
        }

        // --- DOMContentLoaded KÎ›Î—Î£Î— ---
        document.addEventListener('DOMContentLoaded', async () => {
             // 1. ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÏÏŒÎ»Î¿Ï… & ID 
             try {
                // Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Ï„Î·Î½ Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î® URL Î±Ï€ÏŒ Ï„Î¿ Jinja
                const response = await fetch(CHECK_LOGIN_URL); 
                if (!response.ok) throw new Error('Not logged in or session expired.');
                
                const userData = await response.json();
                currentUserId = userData.id;
                currentUserRole = userData.role;
                
                const roleElement = document.getElementById('current_user_role');
                roleElement.textContent = currentUserRole.toUpperCase();

                // ğŸš¨ ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Admin/Owner
                if (currentUserRole !== 'admin' && currentUserRole !== 'owner') {
                    // Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Ï„Î·Î½ Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î® URL Î±Ï€ÏŒ Ï„Î¿ Jinja
                    showMessage('users-message', 'Î†ÏÎ½Î·ÏƒÎ· Î ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚. Î‘Î½Î±ÎºÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ· ÏƒÏ„Î¿ chat.', true);
                    setTimeout(() => {
                         window.location.href = CHAT_URL;
                    }, 2000);
                    return;
                }
             } catch (error) {
                 console.error('Initial Authentication Error:', error);
                 // Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Ï„Î·Î½ Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î® URL Î±Ï€ÏŒ Ï„Î¿ Jinja
                 showMessage('users-message', 'Î£Ï†Î¬Î»Î¼Î± Ï„Î±Ï…Ï„Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚: Î‘Î½Î±ÎºÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ· ÏƒÏ„Î· ÏƒÎµÎ»Î¯Î´Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚.', true);
                 setTimeout(() => {
                     window.location.href = LOGIN_URL;
                 }, 2000);
                 return;
             }

             // 2. Î¦ÏŒÏÏ„Ï‰ÏƒÎ· ÏÏ…Î¸Î¼Î¯ÏƒÎµÏ‰Î½
             await loadSettings();
             
             // 3. Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Emoticons
             await loadEmoticons();

             // 4. Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï‡ÏÎ·ÏƒÏ„ÏÎ½
             await loadUsers();
        });
    </script>
</body>
</html>