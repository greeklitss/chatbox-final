<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Chat Control</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* üö® NEW FUNKY POP ADMIN THEME */
        :root { 
            --primary-color: #FF0066;      /* Hot Pink/Magenta */
            --secondary-color: #00FFCC;    /* Bright Cyan/Turquoise */
            --background-color: #FFEBEB;   /* Very Pale Pink Background */
            --box-bg: #FFFFFF;             /* White/Light Box Background */
            --border-color: #FF77A9;       /* Medium Pink Border */
            --text-color: #333333;
            --button-color: #FFCC00;      /* Yellow/Gold Accent */
            --shadow-admin: 0 8px 20px rgba(255, 0, 102, 0.5);
            --danger-color: #dc3545;      /* Red for dangerous actions */
            --success-color: #28a745;     /* Green for success actions */
        }
        
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color); 
            color: var(--text-color);
            margin: 0;
            padding: 40px 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--box-bg);
            padding: 30px;
            border-radius: 25px;
            border: 4px solid var(--border-color);
            box-shadow: var(--shadow-admin);
        }
        
        h1 {
            color: var(--primary-color);
            text-align: center;
            border-bottom: 3px solid var(--secondary-color);
            padding-bottom: 10px;
            margin-bottom: 30px;
            text-shadow: 1px 1px var(--text-color);
        }
        
        h2 {
            color: var(--primary-color);
            border-left: 5px solid var(--secondary-color);
            padding-left: 10px;
            margin-top: 30px;
            margin-bottom: 20px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px dashed var(--border-color);
            border-radius: 15px;
        }
        
        /* Buttons */
        button {
            background-color: var(--button-color);
            color: var(--text-color); 
            border: none;
            border-radius: 12px;
            padding: 10px 15px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 10px;
            font-weight: 700;
        }
        
        button:hover {
            background-color: var(--primary-color);
            color: #FFFFFF;
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(255, 0, 102, 0.5);
        }
        
        /* Specific Button Styles */
        .user-item button { margin-left: 5px; }
        .user-item button:nth-child(3) { /* Ban button */
            background-color: var(--danger-color);
            color: white;
        }

        /* Settings Items */
        .setting-item, .user-item, .emoticon-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dotted #ccc;
        }
        .user-item {
            padding: 15px 0;
        }
        
        /* Checkbox Styling */
        input[type="checkbox"] {
            transform: scale(1.5);
            accent-color: var(--secondary-color);
        }

        /* Input Fields */
        input[type="text"], input[type="color"] {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #FFF;
            color: var(--text-color);
        }
        input[type="text"]:focus {
             border-color: var(--primary-color);
             box-shadow: 0 0 5px rgba(255, 0, 102, 0.3);
             outline: none;
        }

        /* Emoticons Table */
        .emoticon-item {
            gap: 10px;
            display: grid;
            grid-template-columns: 1.2fr 2fr 1fr 150px; /* Tag, Image URL, Status, Actions */
            padding: 15px 0;
        }
        .emoticon-header {
            font-weight: bold;
            border-bottom: 2px solid var(--primary-color) !important;
            margin-bottom: 10px;
            padding-bottom: 5px !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Admin Control Panel</h1>
        <p style="font-size: 1.1em;">Logged in as: <span id="current_user_role" style="font-weight: bold; color: var(--primary-color);">...</span></p>
        <button onclick="window.location.href='/'" style="background-color: var(--secondary-color); color: var(--text-color);">
            <i class="fas fa-chevron-left"></i> Return to Chat
        </button>

        <div class="section" id="theme-settings-section">
            <h2>üîó Feature Toggle Control (Chat Buttons)</h2>
            <p>ŒïŒΩŒµœÅŒ≥ŒøœÄŒøŒπŒÆœÉœÑŒµ/ŒëœÄŒµŒΩŒµœÅŒ≥ŒøœÄŒøŒπŒÆœÉœÑŒµ œÑŒπœÇ ŒΩŒ≠ŒµœÇ Œ¥œÖŒΩŒ±œÑœåœÑŒ∑œÑŒµœÇ œÑŒøœÖ Chat œÄŒ±Œ≥Œ∫ŒøœÉŒºŒØœâœÇ. (ŒëŒªŒªŒ±Œ≥ŒÆ ŒµŒºœÜŒ±ŒΩŒØŒ∂ŒµœÑŒ±Œπ ŒºŒµ reload)</p>

            <div class="setting-item">
                <label for="toggle-bold"><i class="fas fa-bold"></i> Bold Button ([b])</label>
                <input type="checkbox" id="toggle-bold" data-setting-key="feature_bold">
                <button onclick="saveToggle('feature_bold')">Save</button>
            </div>
            
            <div class="setting-item">
                <label for="toggle-italic"><i class="fas fa-italic"></i> Italic Button ([i])</label>
                <input type="checkbox" id="toggle-italic" data-setting-key="feature_italic">
                <button onclick="saveToggle('feature_italic')">Save</button>
            </div>
            
            <div class="setting-item">
                <label for="toggle-underline"><i class="fas fa-underline"></i> Underline Button ([u])</label>
                <input type="checkbox" id="toggle-underline" data-setting-key="feature_underline">
                <button onclick="saveToggle('feature_underline')">Save</button>
            </div>

            <div class="setting-item">
                <label for="toggle-url"><i class="fas fa-link"></i> Link Button ([url])</label>
                <input type="checkbox" id="toggle-url" data-setting-key="feature_url">
                <button onclick="saveToggle('feature_url')">Save</button>
            </div>
            
            <div class="setting-item">
                <label for="toggle-img"><i class="fas fa-image"></i> GIF/Image Button ([img])</label>
                <input type="checkbox" id="toggle-img" data-setting-key="feature_img">
                <button onclick="saveToggle('feature_img')">Save</button>
            </div>
        </div>
        
        <div class="section">
            <h2><i class="fas fa-smile-wink"></i> Emoticon Management</h2>
            <div class="setting-item" style="border-bottom: none; gap: 10px;">
                <input type="text" id="new-tag" placeholder=":tag:" style="width: 150px;">
                <input type="text" id="new-url" placeholder="Image URL (e.g., /static/emotes/smile.gif)" style="flex-grow: 1;">
                <button onclick="addEmoticon()"><i class="fas fa-plus"></i> Add New</button>
            </div>
            
            <div id="emoticon-list">
                <div class="emoticon-header emoticon-item">
                    <div>Tag</div>
                    <div>Image URL</div>
                    <div>Status</div>
                    <div>Actions</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2><i class="fas fa-users"></i> User Management</h2>
            <div id="user-list">
                </div>
        </div>

    </div>

    <script>
        let currentUserId = null;
        let currentUserRole = null;
        
        // --- HELPER FUNCTIONS ---
        
        // Function to generate HTML for an emoticon item
        function createEmoticonItem(emoticon) {
            const statusText = emoticon.is_enabled ? 'Active' : 'Disabled';
            const statusColor = emoticon.is_enabled ? 'var(--success-color)' : 'var(--danger-color)';
            const actionText = emoticon.is_enabled ? 'Disable' : 'Enable';
            const actionBg = emoticon.is_enabled ? 'var(--danger-color)' : 'var(--success-color)';
            
            return `
                <div class="emoticon-item">
                    <div style="font-weight: bold; color: ${statusColor}">${emoticon.tag}</div>
                    <div style="font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${emoticon.url}</div>
                    <div style="color: ${statusColor};">${statusText}</div>
                    <div>
                        <button onclick="toggleEmoticon(${emoticon.id})" 
                                style="background-color: ${actionBg}; color: white; margin-left: 0;">
                            ${actionText}
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Function to generate HTML for a user item
        function createUserItem(user) {
            let roleColor;
            if (user.role === 'owner') { roleColor = 'var(--primary-color)'; }
            else if (user.role === 'admin') { roleColor = 'var(--secondary-color)'; }
            else if (user.role === 'banned') { roleColor = 'var(--danger-color)'; }
            else { roleColor = 'var(--text-color)'; }

            const isCurrent = (user.id === currentUserId);
            const disabledClass = isCurrent ? 'style="opacity: 0.5; cursor: not-allowed;" disabled' : '';
            const ownerDisabled = (currentUserRole !== 'owner') && (user.role === 'owner' || user.role === 'admin') ? 'style="opacity: 0.5; cursor: not-allowed;" disabled' : '';

            // User cannot change their own role
            const disabledIfSelf = (isCurrent) ? 'disabled' : '';

            return `
                <div class="user-item">
                    <div style="width: 50px;">#${user.id}</div>
                    <div style="flex-grow: 1; font-weight: bold;">
                        ${user.username} 
                        ${isCurrent ? '<span style="color: var(--primary-color); font-size: 0.8em;">(You)</span>' : ''}
                    </div>
                    <div style="width: 100px; text-transform: uppercase; color: ${roleColor}; font-weight: 700;">${user.role}</div>
                    <div style="width: 300px; text-align: right;">
                        <button onclick="toggleUserRole(${user.id}, 'admin')" 
                                ${user.role === 'admin' ? disabledClass : ''} 
                                ${ownerDisabled} 
                                ${disabledIfSelf}>Set Admin</button>
                        <button onclick="toggleUserRole(${user.id}, 'user')" 
                                ${user.role === 'user' ? disabledClass : ''} 
                                ${ownerDisabled} 
                                ${disabledIfSelf}>Set User</button>
                        <button onclick="toggleUserRole(${user.id}, 'banned')" 
                                ${user.role === 'banned' ? disabledClass : ''} 
                                ${ownerDisabled} 
                                ${disabledIfSelf}
                                style="background-color: var(--danger-color); color: white;">Ban</button>
                    </div>
                </div>
            `;
        }
        
        // --- Œ°Œ•ŒòŒúŒôŒ£ŒïŒôŒ£ (SETTINGS) LOGIC ---
        
        async function saveSetting(key, value) {
            try {
                const response = await fetch('/api/admin/set_setting', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key, value })
                });
                if (!response.ok) throw new Error('Failed to save setting.');
                console.log(`Setting ${key} saved.`);
            } catch (error) {
                alert(`ERROR: Could not save setting. Check console.`);
                console.error('Error saving setting:', error);
            }
        }

        function saveToggle(key) {
            const checkbox = document.querySelector(`[data-setting-key="${key}"]`);
            // ŒëœÄŒøŒ∏Œ∑Œ∫ŒµœçŒøœÖŒºŒµ œâœÇ string 'True' ŒÆ 'False'
            const value = checkbox.checked ? 'True' : 'False';
            saveSetting(key, value); 
        }

        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                if (!response.ok) throw new Error('Failed to fetch settings.');
                const settings = await response.json();
                
                // Œ¶œåœÅœÑœâœÉŒ∑ œÑœâŒΩ œÑŒπŒºœéŒΩ œÉœÑŒ± checkboxes
                document.querySelectorAll('[data-setting-key]').forEach(input => {
                    const key = input.dataset.settingKey;
                    if (settings.hasOwnProperty(key)) {
                        // ŒúŒµœÑŒ±œÑœÅŒøœÄŒÆ string 'True'/'False' œÉŒµ boolean
                        input.checked = (settings[key].toString().toLowerCase() === 'true');
                    }
                });
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }
        
        // --- EMOTICON LOGIC ---
        
        async function loadEmoticons() {
            try {
                const response = await fetch('/api/emoticons/all');
                if (!response.ok) throw new Error('Failed to fetch emoticons.');
                const emoticons = await response.json();
                
                const listContainer = document.getElementById('emoticon-list');
                // ŒöœÅŒ±œÑŒ¨ŒºŒµ œÑŒø header Œ∫Œ±Œπ Œ∫Œ±Œ∏Œ±œÅŒØŒ∂ŒøœÖŒºŒµ œÑŒ± œÉœÑŒøŒπœáŒµŒØŒ±
                const header = listContainer.querySelector('.emoticon-header').outerHTML;
                listContainer.innerHTML = header; 
                
                emoticons.forEach(emoticon => {
                    listContainer.innerHTML += createEmoticonItem(emoticon);
                });
                console.log("Emoticons loaded successfully.");
            } catch (error) {
                console.error('Error loading emoticons:', error);
                alert('ERROR: Could not load emoticons. See console.');
            }
        }
        
        async function addEmoticon() {
            const tagInput = document.getElementById('new-tag');
            const urlInput = document.getElementById('new-url');
            const tag = tagInput.value.trim();
            const url = urlInput.value.trim();
            
            if (!tag || !url) {
                alert("Both Tag and Image URL are required.");
                return;
            }
            
            try {
                const response = await fetch('/api/admin/add_emoticon', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tag, url })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    alert(`Error adding emoticon: ${result.error || 'Unknown error'}`);
                    throw new Error(result.error || 'Failed to add emoticon.');
                }

                alert(`Emoticon ${tag} added successfully!`);
                tagInput.value = '';
                urlInput.value = '';
                await loadEmoticons();
                
            } catch (error) {
                console.error('Error adding emoticon:', error);
            }
        }

        async function toggleEmoticon(id) {
            if (!confirm(`Are you sure you want to toggle the status of Emoticon ID ${id}?`)) {
                return;
            }
            try {
                const response = await fetch('/api/admin/toggle_emoticon', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id })
                });
                
                if (!response.ok) throw new Error('Failed to toggle emoticon.');
                
                await loadEmoticons();
                
            } catch (error) {
                console.error(`Error toggling emoticon ${id}:`, error);
                alert('ERROR: Could not toggle emoticon.');
            }
        }

        // --- USER LOGIC ---
        
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                if (!response.ok) throw new Error('Failed to fetch users.');
                const users = await response.json();
                
                const listContainer = document.getElementById('user-list');
                listContainer.innerHTML = ''; // Clear existing list
                
                // Add Header
                listContainer.innerHTML += `
                    <div class="user-item" style="border-bottom: 2px solid var(--primary-color); margin-bottom: 10px; font-weight: bold;">
                        <div style="width: 50px;">ID</div>
                        <div style="flex-grow: 1;">Username</div>
                        <div style="width: 100px;">Role</div>
                        <div style="width: 300px; text-align: right;">Actions</div>
                    </div>
                `;

                // Add Items
                users.forEach(user => {
                    listContainer.innerHTML += createUserItem(user);
                });
                console.log("Users loaded successfully.");

            } catch (error) {
                console.error('Error loading users:', error);
                alert('ERROR: Could not load users. See console.');
            }
        }

        async function toggleUserRole(id, newRole) {
            if (id === currentUserId) {
                alert("You cannot change your own role!");
                return;
            }
            if (!confirm(`Are you sure you want to set User ID ${id} role to "${newRole.toUpperCase()}"?`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/set_role', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: id, role: newRole })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    alert(`Error setting role: ${result.message || 'Unknown error'}`);
                    throw new Error(result.message || 'Failed to set role.');
                }

                alert(`User ID ${id} role set to ${newRole.toUpperCase()}.`);
                await loadUsers();
                
            } catch (error) {
                console.error(`Error setting user role ${id}:`, error);
            }
        }
        
        // --- DOMContentLoaded KŒõŒóŒ£Œó ---
        document.addEventListener('DOMContentLoaded', async () => {
             // 1. ŒàŒªŒµŒ≥œáŒøœÇ œÅœåŒªŒøœÖ & ID 
             try {
                const response = await fetch('/check_login');
                if (!response.ok) throw new Error('Not logged in or session expired.');
                
                const userData = await response.json();
                currentUserId = userData.id;
                currentUserRole = userData.role;
                
                const roleElement = document.getElementById('current_user_role');
                roleElement.textContent = currentUserRole.toUpperCase();

                // üö® ŒàŒªŒµŒ≥œáŒøœÇ Admin/Owner
                if (currentUserRole !== 'admin' && currentUserRole !== 'owner') {
                    alert('Access Denied. Redirecting to chat.');
                    window.location.href = '/';
                    return;
                }
             } catch (error) {
                 alert('Authentication Error: Redirecting to login.');
                 window.location.href = '/login';
                 return;
             }

             // 2. Œ¶œåœÅœÑœâœÉŒ∑ œÅœÖŒ∏ŒºŒØœÉŒµœâŒΩ
             await loadSettings();
             
             // 3. Œ¶œåœÅœÑœâœÉŒ∑ Emoticons
             await loadEmoticons();

             // 4. Œ¶œåœÅœÑœâœÉŒ∑ œáœÅŒ∑œÉœÑœéŒΩ
             await loadUsers();
        });
    </script>
</body>
</html>