<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
<script>
    const API_BASE = '/api/v1';
    let currentUserId = null;
    let currentUserRole = null;
    
    // ----------------------------------------------------
    // 1. UTILITY FUNCTIONS
    // ----------------------------------------------------
    function changeTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });

        document.getElementById(`${tabName}-tab`).classList.add('active');
        document.querySelector(`.tab-button[onclick="changeTab('${tabName}')"]`).classList.add('active');
        
        // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ ÏŒÏ„Î±Î½ Î±Î»Î»Î¬Î¶Î¿Ï…Î¼Îµ ÏƒÎµ ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î± tabs
        if (tabName === 'users') {
            loadUsers();
        }
    }

    // ----------------------------------------------------
    // 2. USER MANAGEMENT LOGIC
    // ----------------------------------------------------

    // A. Load Users from API
    async function loadUsers() {
        const listDiv = document.getElementById('current-users-list');
        listDiv.querySelector('h3').innerHTML = 'Existing Users';
        listDiv.innerHTML = '<p id="users-loading-message">Loading users...</p>';
        
        try {
            const response = await fetch(`${API_BASE}/admin/users`);
            if (!response.ok) throw new Error('Failed to fetch users. Access denied or server error.');
            
            const users = await response.json();
            renderUsers(users);

        } catch (error) {
            listDiv.innerHTML = `<p style="color: var(--color-primary);">Error loading users: ${error.message}.</p>`;
        }
    }

    // B. Render Users Table
    function renderUsers(users) {
        const listDiv = document.getElementById('current-users-list');
        
        let tableHtml = `
            <h3>Existing Users</h3>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nickname</th>
                        <th>Role</th>
                        <th>Login Type</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        users.forEach(user => {
            // Î‘Î½ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î­Ï‡ÎµÎ¹ Google ID ÎµÎ¯Î½Î±Î¹ Google Login, Î±Î»Î»Î¹ÏÏ‚ Traditional (Î±Î½ Î­Ï‡ÎµÎ¹ password_hash)
            let loginType = 'Traditional';
            if (user.google_linked) {
                loginType = 'Google/Hybrid';
            } else if (!user.has_password) {
                // Î‘Ï…Ï„ÏŒ Î´ÎµÎ½ Î¸Î± Î­Ï€ÏÎµÏ€Îµ Î½Î± ÏƒÏ…Î¼Î²Î±Î¯Î½ÎµÎ¹ Î¼Îµ Ï„Î·Î½ Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Î»Î¿Î³Î¹ÎºÎ®
                loginType = 'Unknown'; 
            }
            
            const roleClass = user.role === 'owner' ? 'role-owner' : (user.role === 'admin' ? 'role-admin' : '');
            
            const isOwner = currentUserRole === 'owner';
            const isAdminOrOwner = isOwner || currentUserRole === 'admin';
            
            // Î‘Ï€Î±Î³ÏŒÏÎµÏ…ÏƒÎ· Î±Î»Î»Î±Î³ÏÎ½ ÏƒÏ„Î¿Î½ ÎµÎ±Ï…Ï„ÏŒ Î¼Î±Ï‚
            const selfActionDisabled = user.id === currentUserId ? 'disabled' : '';

            let actions = `
                <button class="action-btn btn-edit" ${selfActionDisabled} onclick="openEditUserModal(${user.id}, '${user.display_name}', '${user.role}')"><i class="fas fa-edit"></i> Edit</button>
            `;
            
            if (isAdminOrOwner && user.role !== 'owner') {
                // Admin/Owner Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎ¿Ï…Î½ (ÎµÏ†ÏŒÏƒÎ¿Î½ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Owner Î¿ ÏƒÏ„ÏŒÏ‡Î¿Ï‚)
                actions += `<button class="action-btn btn-delete" ${selfActionDisabled} onclick="deleteUser(${user.id}, '${user.display_name}')"><i class="fas fa-trash-alt"></i> Delete</button>`;
            } else if (isOwner) {
                // Owner Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹ Owners/Admins/Users
                 actions += `<button class="action-btn btn-delete" ${selfActionDisabled} onclick="deleteUser(${user.id}, '${user.display_name}')"><i class="fas fa-trash-alt"></i> Delete</button>`;
            }


            tableHtml += `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.display_name}</td>
                    <td class="${roleClass}">${user.role.toUpperCase()}</td>
                    <td>${loginType}</td>
                    <td>${actions}</td>
                </tr>
            `;
        });

        tableHtml += `</tbody></table>`;
        listDiv.innerHTML = tableHtml;
    }

    // C. Handle User Creation (AJAX)
    // ... (createUser function remains the same as before) ...
    async function createUser(event) {
        event.preventDefault(); 
        const form = document.getElementById('create-user-form');
        const messageDiv = document.getElementById('create-user-message');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        messageDiv.innerHTML = 'Creating user...';
        messageDiv.style.color = 'orange';

        try {
            const response = await fetch('/admin_create_user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify(data) 
            });

            const result = await response.json();

            if (response.ok) {
                messageDiv.innerHTML = `Success: ${result.message}`;
                messageDiv.style.color = 'var(--color-secondary)';
                form.reset(); 
                await loadUsers();
            } else {
                messageDiv.innerHTML = `Error: ${result.error || 'Failed to create user.'}`;
                messageDiv.style.color = 'var(--color-primary)';
            }
        } catch (error) {
            console.error('Network or system error:', error);
            messageDiv.innerHTML = 'A critical error occurred.';
            messageDiv.style.color = 'var(--color-primary)';
        }
    }

    
    // D. ğŸš¨ ÎÎ•ÎŸ: Î”Î¹Î±Î³ÏÎ±Ï†Î® Î§ÏÎ®ÏƒÏ„Î· (AJAX)
    async function deleteUser(id, name) {
        if (!confirm(`Are you sure you want to permanently delete user ${name} (ID: ${id})?`)) {
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/admin/user/${id}/delete`, {
                method: 'DELETE',
            });
            
            const result = await response.json();

            if (response.ok) {
                alert(`Success: ${result.message}`);
                await loadUsers(); // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Î¿Ï… Ï€Î¯Î½Î±ÎºÎ±
            } else {
                alert(`Error: ${result.error || 'Failed to delete user.'}`);
            }
        } catch (error) {
            alert('Network error during user deletion.');
        }
    }
    
    // ----------------------------------------------------
    // 3. ADMIN ACTIONS STUBS (Î˜Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ½ Ï„Î¿ /update route)
    // ----------------------------------------------------

    function openEditUserModal(id, currentName, currentRole) {
        alert(`Î•Ï„Î¿Î¹Î¼Î±ÏƒÎ¯Î± Modal Î³Î¹Î± ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Ï‡ÏÎ®ÏƒÏ„Î· ID: ${id}. Î˜Î± Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î±Î»Î»Î¬Î¾ÎµÏ„Îµ Nickname, Password ÎºÎ±Î¹ Role.`);
        // Î•Î´Ï Î¸Î± Ï…Î»Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Ï„Î¿ modal Ï€Î¿Ï… Î¸Î± ÎºÎ±Î»ÎµÎ¯ Ï„Î¿ /api/v1/admin/user/<id>/update
    }
    
    // ----------------------------------------------------
    // 4. Initialization
    // ----------------------------------------------------

    document.addEventListener('DOMContentLoaded', async () => {
         // 1. ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Ï„Î±Ï…Ï„ÏŒÏ„Î·Ï„Î±Ï‚ Ï‡ÏÎ®ÏƒÏ„Î·
         try {
             const response = await fetch('/check_login');
             if (!response.ok) throw new Error('Not logged in or session expired.');
             
             const userData = await response.json();
             currentUserId = userData.id;
             currentUserRole = userData.role;
             
             const roleElement = document.getElementById('current_user_role');
             roleElement.textContent = currentUserRole.toUpperCase();

             if (currentUserRole !== 'admin' && currentUserRole !== 'owner') {
                 alert('Access Denied. Redirecting to chat.');
                 window.location.pathname = '/chat';
                 return;
             }
             
             // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Owner Settings
             if (currentUserRole !== 'owner') {
                document.querySelector('.owner-only-settings').style.display = 'none';
             }

          } catch (error) {
              alert('Authentication Error: Redirecting to login.');
              window.location.pathname = '/login';
              return;
          }

          // 2. Attach Listeners
          const createUserForm = document.getElementById('create-user-form');
          if (createUserForm) {
              createUserForm.addEventListener('submit', createUser);
          }

          // 3. Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï‡ÏÎ·ÏƒÏ„ÏÎ½ (Î±ÏÏ‡Î¹ÎºÎ® Ï†ÏŒÏÏ„Ï‰ÏƒÎ· Î³Î¹Î± Ï„Î¿ User Management tab)
          await loadUsers();
     });
</script>