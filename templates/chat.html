<!DOCTYPE html>
<html>
<head>
    <title>Radio Parea Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { margin: 0; font-family: sans-serif; background: #121212; color: white; overflow: hidden; }
        
        /* 1. Player Bar */
        .player-bar { height: 60px; background: #1a1a1a; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 2px solid #00ffc0; }
        .metadata { font-weight: bold; color: #00ffc0; }
        .volume-ctrl { display: flex; align-items: center; gap: 10px; }

        /* 2. Main Layout */
        .main-container { display: flex; height: calc(100vh - 62px); }
        #chat-column { flex: 1; display: flex; flex-direction: column; background: #1e1e1e; }
        #sidebar { width: 250px; background: #181818; border-left: 1px solid #333; padding: 10px; }

        /* 3. Messages Area */
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg-item { background: #2a2a2a; padding: 8px 12px; border-radius: 8px; max-width: 80%; }
        .msg-avatar { width: 30px; height: 30px; border-radius: 50%; vertical-align: middle; margin-right: 8px; }
        .embed-img img { max-width: 300px; border-radius: 10px; margin-top: 10px; }
        .embed-video iframe { width: 100%; max-width: 400px; height: 225px; margin-top: 10px; }

        /* 4. Input Area & Toolbar */
        .input-area { padding: 15px; background: #1a1a1a; border-top: 1px solid #333; }
        .toolbar { display: flex; gap: 15px; margin-bottom: 10px; }
        .toolbar button, .toolbar input { background: none; border: none; color: #ccc; cursor: pointer; font-size: 1.1em; }
        .input-row { display: flex; gap: 10px; }
        #message-input { flex: 1; padding: 10px; border-radius: 5px; border: none; background: #333; color: white; }
        #send-btn { background: #00ffc0; color: black; border: none; padding: 0 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }

        /* Sidebar Users */
        .user-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-size: 0.9em; }

        /* Modals */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: #222; margin: 10% auto; padding: 20px; width: 40%; border-radius: 10px; position: relative; }
        .close { position: absolute; right: 20px; top: 10px; font-size: 25px; cursor: pointer; }
    </style>
</head>
<body>

<div class="player-bar">
    <div class="metadata" id="track-info">Radio Parea - Live Stream</div>
    <audio id="radio-player" src="ΣΥΝΔΕΣΜΟΣ_ΕΔΩ"></audio>
    <div class="volume-ctrl">
        <i class="fas fa-volume-up"></i>
        <input type="range" id="volume" min="0" max="1" step="0.1" value="0.5">
    </div>
</div>

<div class="main-container">
    <div id="chat-column">
        <div id="messages">
            {% for msg in messages %}
            <div class="msg-item">
                <img src="{{ msg.author.avatar_url or '/static/default.png' }}" class="msg-avatar">
                <b style="color: {{ msg.author.color }}">{{ msg.author.display_name }}:</b>
                <span class="text-content">{{ msg.content | safe }}</span>
            </div>
            {% endfor %}
        </div>
        
        <div class="input-area">
            <div class="toolbar">
                <button onclick="applyBold()"><i class="fas fa-bold"></i></button>
                <input type="color" id="text-color" value="#ffffff">
                <button onclick="showEmoji()"><i class="far fa-smile"></i></button>
                <button onclick="toggleModal('admin-modal')"><i class="fas fa-cog"></i></button>
            </div>
            <div class="input-row">
                <input type="text" id="message-input" placeholder="Πληκτρολογήστε μήνυμα...">
                <button id="send-btn">Αποστολή</button>
            </div>
        </div>
    </div>

    <div id="sidebar">
        <h4>Online Users</h4>
        <div id="user-list"></div>
    </div>
</div>

<div id="admin-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="toggleModal('admin-modal')">&times;</span>
        <h3>Ρυθμίσεις Διαχειριστή</h3>
        <p>Εδώ θα μπουν οι λειτουργίες του Admin Panel.</p>
    </div>
</div>

<script>
    const socket = io();
    const msgInput = document.getElementById('message-input');
    const msgContainer = document.getElementById('messages');

    // 1. YouTube & Image Parser
    function parseContent(text) {
        const imgRegex = /(https?:\/\/.*\.(?:png|jpg|jpeg|gif))/g;
        const ytRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com|youtu\.be)\/watch\?v=([^&\s]+)/g;
        
        text = text.replace(imgRegex, '<div class="embed-img"><img src="$1"></div>');
        text = text.replace(ytRegex, '<div class="embed-video"><iframe src="https://www.youtube.com/embed/$1" frameborder="0" allowfullscreen></iframe></div>');
        return text;
    }

    // 2. Send Message
    document.getElementById('send-btn').onclick = () => {
        const color = document.getElementById('text-color').value;
        let content = msgInput.value;
        if(content.trim() === "") return;
        
        // Wrap with color span
        content = `<span style="color: ${color}">${content}</span>`;
        socket.emit('message', {content: content});
        msgInput.value = '';
    };

    // 3. Receive Message
    socket.on('message', (data) => {
        const div = document.createElement('div');
        div.className = 'msg-item';
        div.innerHTML = `
            <img src="${data.avatar_url || '/static/default.png'}" class="msg-avatar">
            <b style="color: ${data.color}">${data.display_name}:</b>
            <span>${parseContent(data.content)}</span>
        `;
        msgContainer.appendChild(div);
        msgContainer.scrollTop = msgContainer.scrollHeight;
    });

    // 4. Update Online Users
    socket.on('users_update', (users) => {
        const list = document.getElementById('user-list');
        list.innerHTML = users.map(u => `
            <div class="user-row">
                <img src="${u.avatar_url || '/static/default.png'}" class="msg-avatar" style="width:20px;height:20px;">
                <span style="color:${u.color}">${u.display_name}</span>
            </div>
        `).join('');
    });

    // 5. Volume Control
    document.getElementById('volume').oninput = (e) => {
        document.getElementById('radio-player').volume = e.target.value;
    };

    function toggleModal(id) {
        const m = document.getElementById(id);
        m.style.display = (m.style.display === 'block') ? 'none' : 'block';
    }

    function applyBold() {
        msgInput.value += "<b></b>";
        msgInput.focus();
    }
</script>
</body>
</html>