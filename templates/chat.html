<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatBox - Î£Ï…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚ Ï‰Ï‚ {{ user.display_name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        /* Î ÏÎ¿ÏƒÎ±ÏÎ¼Î¿ÏƒÎ¼Î­Î½Î¿ Scrollbar - ÎºÎ¬Î½ÎµÎ¹ Ï„Î¿ chatbox Î½Î± Ï†Î±Î¯Î½ÎµÏ„Î±Î¹ Ï€Î¹Î¿ ÎºÎ±Î¸Î±ÏÏŒ */
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background-color: #888;
            border-radius: 4px;
        }
        .chat-container::-webkit-scrollbar-thumb:hover {
            background-color: #555;
        }
        /* Î ÏÎ¿ÏƒÎ±ÏÎ¼Î¿ÏƒÎ¼Î­Î½Î¿ style Î³Î¹Î± Ï„Î± Emoticons, ÏÏƒÏ„Îµ Î½Î± Î­Ï‡Î¿Ï…Î½ ÏƒÏ„Î±Î¸ÎµÏÏŒ Î¼Î­Î³ÎµÎ¸Î¿Ï‚ */
        .emoticon-img {
            display: inline-block;
            width: 20px;
            height: 20px;
            vertical-align: middle;
            margin: 0 1px;
        }
        /* ÎšÏÏ…Ï†ÏŒ Î³Î¹Î± browsers Ï€Î¿Ï… Î´ÎµÎ½ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶Î¿Ï…Î½ Ï„Î¿ audio tag */
        #radio-player {
            width: 100%;
            height: 30px; 
            min-width: 200px; /* Î•Î»Î¬Ï‡Î¹ÏƒÏ„Î¿ Ï€Î»Î¬Ï„Î¿Ï‚ Î³Î¹Î± ÎºÎ¹Î½Î·Ï„Î¬ */
        }
    </style>
</head>
<body class="bg-gray-100 flex h-screen antialiased">

    <div class="flex-1 flex flex-col">
        
        <header class="bg-white p-4 shadow-md flex justify-between items-center z-10">
            <h1 class="text-2xl font-bold text-indigo-600">ChatBox</h1>
            
            <div class="flex items-center space-x-4">
                {% if settings.feature_radio == 'True' and radio_url %}
                
                <div id="now-playing-info" class="text-sm font-medium text-gray-700 hidden sm:block truncate max-w-xs">
                    Loading...
                </div>
                
                <audio id="radio-player" controls loop class="h-8">
                    <source src="{{ radio_url }}" type="audio/mpeg">
                    ÎŸ browser ÏƒÎ±Ï‚ Î´ÎµÎ½ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÎ¹ Ï„Î¿ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î¿ Î®Ï‡Î¿Ï….
                </audio>
                
                {% endif %}

                <span class="text-gray-700 hidden sm:inline">Î£Ï…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚ Ï‰Ï‚: <span class="font-semibold" style="color: {{ user.color }};">{{ user.display_name }}</span></span>
                <a href="{{ url_for('logout') }}" class="px-3 py-1 bg-red-500 text-white text-sm font-medium rounded-full hover:bg-red-600 transition duration-150">
                    ÎˆÎ¾Î¿Î´Î¿Ï‚
                </a>
            </div>
        </header>

        <main class="flex-1 flex overflow-hidden">
            
            <div class="flex flex-col flex-grow w-full lg:w-3/4 bg-white border-r">
                
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4 chat-container">
                    {% for message in initial_messages %}
                        <div id="msg-{{ message.id }}" class="flex items-start space-x-3">
                            <img src="{{ message.avatar_url }}" alt="{{ message.username }}" class="w-10 h-10 rounded-full object-cover">
                            <div>
                                <div class="flex items-center space-x-2">
                                    <span class="font-semibold text-sm" style="color: {{ message.color }};">{{ message.username }}</span>
                                    <span class="text-xs text-gray-500">{{ message.timestamp }}</span>
                                </div>
                                <div class="bg-gray-50 p-2 rounded-lg shadow-sm text-gray-800 break-words max-w-lg md:max-w-xl message-content">{{ message.content|safe }}</div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <div class="p-4 border-t bg-gray-50">
                    <div class="flex space-x-2 mb-2">
                        {% if settings.feature_bold == 'True' %}
                        <button id="btn-bold" class="p-1.5 bg-indigo-100 text-indigo-700 rounded-lg font-bold hover:bg-indigo-200 transition duration-150">B</button>
                        {% endif %}
                        {% if settings.feature_italic == 'True' %}
                        <button id="btn-italic" class="p-1.5 bg-indigo-100 text-indigo-700 rounded-lg italic hover:bg-indigo-200 transition duration-150">I</button>
                        {% endif %}
                        {% if settings.feature_underline == 'True' %}
                        <button id="btn-underline" class="p-1.5 bg-indigo-100 text-indigo-700 rounded-lg underline hover:bg-indigo-200 transition duration-150">U</button>
                        {% endif %}
                        <div class="relative inline-block text-left">
                            <button id="btn-emoticon" class="p-1.5 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition duration-150">
                                ğŸ˜€
                            </button>
                            <div id="emoticon-dropdown" class="absolute bottom-full mb-1 left-0 z-20 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden p-2 grid grid-cols-4 gap-1">
                                </div>
                        </div>
                        
                    </div>
                    
                    <form id="message-form" class="flex space-x-3">
                        <input type="text" id="message-input" placeholder="Î Î»Î·ÎºÏ„ÏÎ¿Î»Î¿Î³Î®ÏƒÏ„Îµ Ï„Î¿ Î¼Î®Î½Ï…Î¼Î¬ ÏƒÎ±Ï‚..." maxlength="{{ settings.max_message_length }}" autocomplete="off"
                               class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                        <button type="submit" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 flex items-center justify-center">
                            Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®
                        </button>
                    </form>
                    <p class="text-xs text-gray-500 mt-1">ÎœÎ­Î³Î¹ÏƒÏ„Î¿ Î¼Î®ÎºÎ¿Ï‚: {{ settings.max_message_length }} Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚.</p>
                </div>
            </div>

            <div class="hidden lg:block w-1/4 bg-gray-50 p-4 shadow-inner overflow-y-auto">
                <h2 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-3">Online Î§ÏÎ®ÏƒÏ„ÎµÏ‚ (<span id="online-count">0</span>)</h2>
                <div id="online-users-list" class="space-y-2">
                    </div>
            </div>
        </main>
    </div>

    <script>
        // Î¦Î¿ÏÏ„ÏÎ½ÎµÎ¹ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î±Ï€ÏŒ Ï„Î¿ Flask
        const initialMessages = JSON.parse('{{ initial_messages | tojson | safe }}');
        const emoticons = JSON.parse('{{ emoticons | tojson | safe }}');
        const currentUser = JSON.parse('{{ user | tojson | safe }}');
        const settings = JSON.parse('{{ settings | tojson | safe }}');
        
        const socket = io();
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const emoticonDropdown = document.getElementById('emoticon-dropdown');
        
        // --- Utility Functions ---

        /**
         * ÎœÎµÏ„Î±Ï„ÏÎ­Ï€ÎµÎ¹ Ï„Î¿ Î±Ï€Î»ÏŒ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ ÏƒÎµ HTML, Î±Î½Ï„Î¹ÎºÎ±Î¸Î¹ÏƒÏ„Î¬ Ï„Î¿Ï…Ï‚ ÎºÏ‰Î´Î¹ÎºÎ¿ÏÏ‚ emoticon 
         * Î¼Îµ ÎµÎ¹ÎºÏŒÎ½ÎµÏ‚ ÎºÎ±Î¹ Ï€ÏÎ¿ÏƒÎ¸Î­Ï„ÎµÎ¹ Î²Î±ÏƒÎ¹ÎºÎ® Î¼Î¿ÏÏ†Î¿Ï€Î¿Î¯Î·ÏƒÎ·.
         */
        function parseMessageContent(content) {
            let processedContent = content;
            
            // 1. Î‘Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Emoticons (Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î³Î¯Î½ÎµÎ¹ Ï€ÏÏÏ„Î±)
            for (const code in emoticons) {
                const url = emoticons[code];
                const imgTag = `<img src="${url}" alt="${code}" class="emoticon-img" title="${code}">`;
                // Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ regex Î¼Îµ escape Î³Î¹Î± Î½Î± Î±Î½Ï„Î¹ÎºÎ±Ï„Î±ÏƒÏ„Î®ÏƒÎ¿Ï…Î¼Îµ Î¼ÏŒÎ½Î¿ Î¿Î»ÏŒÎºÎ»Î·ÏÎµÏ‚ Î»Î­Î¾ÎµÎ¹Ï‚ (ÎºÏ‰Î´Î¹ÎºÎ¿ÏÏ‚)
                const regex = new RegExp(escapeRegExp(code), 'g');
                processedContent = processedContent.replace(regex, imgTag);
            }

            // 2. ÎœÎ¿ÏÏ†Î¿Ï€Î¿Î¯Î·ÏƒÎ· ÎºÎµÎ¹Î¼Î­Î½Î¿Ï… (Î±Î½Ï„Î¹ÎºÎ±Î¸Î¹ÏƒÏ„Î¬ tags Ï„ÏÏ€Î¿Ï… [b]text[/b])
            if (settings.feature_bold === 'True') {
                 processedContent = processedContent.replace(/\[b\](.*?)\[\/b\]/gi, '<b>$1</b>');
            }
            if (settings.feature_italic === 'True') {
                 processedContent = processedContent.replace(/\[i\](.*?)\[\/i\]/gi, '<i>$1</i>');
            }
            if (settings.feature_underline === 'True') {
                 processedContent = processedContent.replace(/\[u\](.*?)\[\/u\]/gi, '<u>$1</u>');
            }
            
            // ÎšÏÎ±Ï„Î¬Î¼Îµ Ï„Î¹Ï‚ Î±Î»Î»Î±Î³Î­Ï‚ Î³ÏÎ±Î¼Î¼Î®Ï‚
            processedContent = processedContent.replace(/\n/g, '<br>');

            return processedContent;
        }

        /** Î’Î¿Î·Î¸Î·Ï„Î¹ÎºÎ® ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Î³Î¹Î± Ï„Î·Î½ escape Ï„Ï‰Î½ regex Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÏ‰Î½ */
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        /** Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ Ï„Î¿ HTML Î³Î¹Î± Î­Î½Î± Î¼Î®Î½Ï…Î¼Î± ÎºÎ±Î¹ Ï„Î¿ Ï€ÏÎ¿ÏƒÎ¸Î­Ï„ÎµÎ¹ ÏƒÏ„Î¿ container. */
        function createMessageElement(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'flex items-start space-x-3';
            messageElement.id = `msg-${message.id}`;
            
            const contentHTML = parseMessageContent(message.content);

            messageElement.innerHTML = `
                <img src="${message.avatar_url}" alt="${message.username}" class="w-10 h-10 rounded-full object-cover">
                <div>
                    <div class="flex items-center space-x-2">
                        <span class="font-semibold text-sm" style="color: ${message.color};">${message.username}</span>
                        <span class="text-xs text-gray-500">${message.timestamp}</span>
                    </div>
                    <div class="bg-gray-50 p-2 rounded-lg shadow-sm text-gray-800 break-words max-w-lg md:max-w-xl message-content">${contentHTML}</div>
                </div>
            `;
            messagesContainer.appendChild(messageElement);
        }

        /** Î£ÎºÏÎ¿Î»Î¬ÏÎµÎ¹ ÏƒÏ„Î¿ ÎºÎ¬Ï„Ï‰ Î¼Î­ÏÎ¿Ï‚ Ï„Î¿Ï… container. */
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // --- Event Listeners & SocketIO Handlers ---

        // 1. Î¦ÏŒÏÎ¼Î± Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚ ÎœÎ·Î½ÏÎ¼Î±Ï„Î¿Ï‚
        document.getElementById('message-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const content = messageInput.value.trim();

            if (content.length > 0 && content.length <= parseInt(settings.max_message_length)) {
                socket.emit('new_message', { 
                    content: content, 
                    room: 'main' 
                });
                messageInput.value = ''; 
            } else if (content.length > parseInt(settings.max_message_length)) {
                console.error(`Î¤Î¿ Î¼Î®Î½Ï…Î¼Î± ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Ï Î¼ÎµÎ³Î¬Î»Î¿. ÎœÎ­Î³Î¹ÏƒÏ„Î¿: ${settings.max_message_length} Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚.`);
            }
        });

        // 2. Î›Î®ÏˆÎ· ÎÎ­Î¿Ï… ÎœÎ·Î½ÏÎ¼Î±Ï„Î¿Ï‚
        socket.on('new_message', function(message) {
            createMessageElement(message);
            scrollToBottom();
        });
        
        // 3. Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Online Î§ÏÎ·ÏƒÏ„ÏÎ½
        socket.on('online_users_update', function(data) {
            const listContainer = document.getElementById('online-users-list');
            const countElement = document.getElementById('online-count');
            listContainer.innerHTML = ''; 

            data.users.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'flex items-center space-x-3 p-2 bg-white rounded-lg shadow-sm';
                userElement.innerHTML = `
                    <img src="${user.avatar_url}" alt="${user.display_name}" class="w-8 h-8 rounded-full object-cover">
                    <span class="font-medium text-sm" style="color: ${user.color};">${user.display_name}</span>
                    <span class="text-xs text-gray-400">(${user.role})</span>
                `;
                listContainer.appendChild(userElement);
            });
            countElement.textContent = data.users.length;
        });

        // 4. Î§ÎµÎ¹ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î•ÏÎ³Î±Î»ÎµÎ¯Ï‰Î½ ÎœÎ¿ÏÏ†Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚ (Bold, Italic, Underline)
        function applyFormatting(tag) {
            const startTag = `[${tag}]`;
            const endTag = `[/${tag}]`;
            let input = messageInput;
            let value = input.value;
            let start = input.selectionStart;
            let end = input.selectionEnd;

            if (start !== undefined && end !== undefined && start !== end) {
                const selectedText = value.substring(start, end);
                const newText = startTag + selectedText + endTag;
                input.value = value.substring(0, start) + newText + value.substring(end);
                input.focus();
                input.selectionStart = start + newText.length;
                input.selectionEnd = start + newText.length;
            } else {
                input.value += startTag + endTag;
                input.focus();
                input.selectionStart = input.selectionEnd = input.value.length - endTag.length;
            }
        }
        
        document.getElementById('btn-bold')?.addEventListener('click', (e) => { e.preventDefault(); applyFormatting('b'); });
        document.getElementById('btn-italic')?.addEventListener('click', (e) => { e.preventDefault(); applyFormatting('i'); });
        document.getElementById('btn-underline')?.addEventListener('click', (e) => { e.preventDefault(); applyFormatting('u'); });

        // 5. Î¦ÏŒÏÏ„Ï‰ÏƒÎ· ÎºÎ±Î¹ Î§ÎµÎ¹ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Emoticons
        const btnEmoticon = document.getElementById('btn-emoticon');
        if (btnEmoticon) {
            for (const code in emoticons) {
                const url = emoticons[code];
                const emoticonBtn = document.createElement('button');
                emoticonBtn.className = 'p-1 hover:bg-gray-100 rounded-md transition duration-100';
                emoticonBtn.innerHTML = `<img src="${url}" alt="${code}" class="w-6 h-6 emoticon-img" title="${code}">`;
                
                emoticonBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    messageInput.value += ` ${code} `;
                    messageInput.focus();
                    emoticonDropdown.classList.add('hidden');
                });
                emoticonDropdown.appendChild(emoticonBtn);
            }

            btnEmoticon.addEventListener('click', (e) => {
                e.preventDefault();
                emoticonDropdown.classList.toggle('hidden');
            });

            document.addEventListener('click', function(event) {
                if (!emoticonDropdown.contains(event.target) && !btnEmoticon.contains(event.target)) {
                    emoticonDropdown.classList.add('hidden');
                }
            });
        }


        // 6. Î¤ÎµÎ»Î¹ÎºÎ® Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ·
        window.onload = function() {
            const initialElements = messagesContainer.querySelectorAll('.message-content');
            initialElements.forEach(el => {
                el.innerHTML = parseMessageContent(el.textContent);
            });

            scrollToBottom();
        };

        // ----------------------------------------------------
        // 7. RADIO PLAYER LOGIC (NOW PLAYING)
        // ----------------------------------------------------
        const nowPlayingElement = document.getElementById('now-playing-info');
        // Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Ï„Î¿ API URL Ï€Î¿Ï… ÎµÎ½Ï„Î¿Ï€Î¯ÏƒÎ±Î¼Îµ
        const apiURL = 'https://or.mysonicserver.com/cp/get_info.php?p=8050';

        function fetchNowPlaying() {
            if (!nowPlayingElement) return;

            fetch(apiURL)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.title) {
                        const title = data.title;
                        const listeners = data.listeners || 0;
                        // const djUsername = data.djusername || 'Station'; // Î‘Î½ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Ï„Î¿ ÎµÎ¼Ï†Î±Î½Î¯ÏƒÎµÏ„Îµ

                        // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Ï„Ï‰Î½ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¹ÏÎ½ (Î±Î½ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î®Î´Î· Î¿ÏÎ±Ï„ÏŒ, Ï„Î¿ ÎµÎ¼Ï†Î±Î½Î¯Î¶Î¿Ï…Î¼Îµ)
                        nowPlayingElement.classList.remove('hidden'); 
                        nowPlayingElement.innerHTML = `
                            <span class="text-indigo-600">LIVE:</span> 
                            ${title} 
                            <span class="text-xs text-gray-500 ml-2">(${listeners} listeners)</span>
                        `;
                    } else {
                        nowPlayingElement.textContent = "Live Stream Info N/A.";
                    }
                })
                .catch(error => {
                    console.error('Error fetching Now Playing data:', error);
                    nowPlayingElement.textContent = "Error loading info.";
                });
        }

        // 1. ÎšÎ±Î»Î­ÏƒÏ„Îµ Ï„Î·Î½ Î±ÏÏ‡Î¹ÎºÎ® Ï†ÏŒÏÏ„Ï‰ÏƒÎ·
        fetchNowPlaying(); 

        // 2. Î¡Ï…Î¸Î¼Î¯ÏƒÏ„Îµ Ï„Î·Î½ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î±Î½Î±Î½Î­Ï‰ÏƒÎ· (ÎºÎ¬Î¸Îµ 5 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î±)
        setInterval(fetchNowPlaying, 5000); 

    </script>
</body>
</html>