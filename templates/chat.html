<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <title>Radio Parea - Crystal Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        :root { --gold: #D4AF37; --danger: #e74c3c; }
        body { 
            margin: 0; background: url("{{ url_for('static', filename='radioparea_background.jpg') }}") no-repeat center center fixed; 
            background-size: cover; color: white; height: 100vh; overflow: hidden; font-family: 'Roboto';
        }

        /* Œ¶Œ©Œ§ŒüŒ°Œ•ŒòŒúŒôŒöŒë */
        .disco {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none;
            background: radial-gradient(circle at 50% 50%, rgba(212,175,55,0.1), rgba(192,57,43,0.05), transparent);
            animation: moveDisco 10s infinite alternate;
        }
        @keyframes moveDisco { 0% { filter: hue-rotate(0deg); opacity: 0.3; } 100% { filter: hue-rotate(360deg); opacity: 0.6; } }

        /* HEADER */
        .header {
            position: relative; z-index: 10; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--gold); display: flex; align-items: center; padding: 8px 20px; gap: 15px;
        }
        .dj-avatar { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--gold); box-shadow: 0 0 10px var(--gold); }

        /* CHAT AREA */
        .main { display: flex; height: calc(100vh - 70px); position: relative; z-index: 5; }
        #chat-col { flex: 1; display: flex; flex-direction: column; background: transparent; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; text-shadow: 2px 2px 4px #000; }
        
        .msg-line { margin-bottom: 10px; font-size: 1.1em; position: relative; }
        .del-btn { color: var(--danger); cursor: pointer; visibility: hidden; margin-left: 10px; font-size: 0.8em; }
        .msg-line:hover .del-btn { visibility: visible; }

        /* LINK PREVIEW */
        .preview-card {
            display: flex; background: rgba(0,0,0,0.6); border: 1px solid var(--gold);
            border-radius: 8px; margin: 8px 0; max-width: 380px; overflow: hidden; text-decoration: none; color: white;
        }
        .preview-card img { width: 80px; height: 80px; object-fit: cover; }
        .preview-info { padding: 8px; font-size: 0.85em; }

        /* INPUT & TOOLS */
        .input-box { background: rgba(0,0,0,0.85); padding: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
        .tools { display: flex; gap: 15px; margin-bottom: 10px; align-items: center; }
        #message-input { width: 100%; padding: 12px 20px; border-radius: 25px; border: 1px solid var(--gold); background: rgba(255,255,255,0.05); color: white; outline: none; }

        /* SETTINGS MODAL */
        #settings { 
            display: none; position: fixed; top: 80px; left: 20px; z-index: 100;
            background: rgba(0,0,0,0.95); padding: 20px; border: 1px solid var(--gold); border-radius: 10px; width: 250px;
        }
        .sidebar { width: 250px; background: rgba(0,0,0,0.6); backdrop-filter: blur(15px); border-left: 1px solid #333; }
    </style>
</head>
<body>
    <div class="disco"></div>
    <div class="header">
        <img src="/static/dj_default.png" id="dj-img" class="dj-avatar">
        <div style="flex:1; font-family:'Orbitron'; color:var(--gold); font-size:0.85em; white-space:nowrap; overflow:hidden;">
            üéôÔ∏è <span id="t_dj">...</span> | üéµ <span id="t_title">Loading...</span> | üë• <span id="t_listeners">0</span>
        </div>
        <i class="fas fa-cog" style="cursor:pointer;" onclick="toggleSet()"></i>
    </div>

    <div class="main">
        <div id="chat-col">
            <div id="messages">{% for m in messages %}<div class="msg-line" id="msg-{{m.id}}"><span style="color:{{m.author.color}}; font-weight:bold;">{{m.author.display_name}}:</span> {{m.content}}{% if current_user.role in ['admin','owner'] %}<i class="fas fa-trash del-btn" onclick="deleteMsg({{m.id}})"></i>{% endif %}</div>{% endfor %}</div>
            <div class="input-box">
                <div class="tools">
                    <i class="fas fa-bell" id="bell" onclick="toggleMute()" style="cursor:pointer; color:var(--gold);"></i>
                    {% if current_user.role in ['admin','owner'] %}<button onclick="clearChat()" style="background:var(--danger); border:none; color:white; padding:3px 8px; border-radius:4px; font-size:0.7em;">CLEAR CHAT</button>{% endif %}
                </div>
                <input type="text" id="message-input" placeholder="ŒìœÅŒ¨œàŒµ œÉœÑŒ∑ŒΩ œÄŒ±œÅŒ≠Œ±...">
            </div>
        </div>
        <div class="sidebar">
            <div style="padding:15px; border-bottom:1px solid #333; color:var(--gold); font-family:'Dancing Script'; font-size:1.4em;">Online</div>
            <div id="user-list" style="padding:15px;"></div>
        </div>
    </div>

    <div id="settings">
        <h4 style="margin:0 0 10px 0; color:var(--gold);">Œ†œÅŒøœÜŒØŒª</h4>
        <input type="text" id="new-name" placeholder="ŒåŒΩŒøŒºŒ±" style="width:100%; margin-bottom:10px;" {% if not current_user.can_change_name and current_user.role == 'user' %}disabled{% endif %}>
        <input type="color" id="new-color" value="{{current_user.color}}" style="width:100%; height:30px; margin-bottom:10px;">
        <button onclick="saveSet()" style="width:100%; background:var(--gold); border:none; padding:8px; cursor:pointer;">ŒëœÄŒøŒ∏ŒÆŒ∫ŒµœÖœÉŒ∑</button>
    </div>

    <audio id="notif" src="https://www.soundjay.com/buttons/beep-07a.mp3"></audio>
    <div style="display:none;"><span id="sonic_dj"></span><span id="sonic_title"></span><span id="sonic_listeners"></span></div>
    <script id='sonic_js' data-port='8050' src='https://or.mysonicserver.com/cp/widgets.js?r=381'></script>

    <script>
        const socket = io();
        let muted = false;

        function toggleSet() { const s = document.getElementById('settings'); s.style.display = s.style.display === 'block' ? 'none' : 'block'; }
        function toggleMute() { muted = !muted; document.getElementById('bell').className = muted ? 'fas fa-bell-slash' : 'fas fa-bell'; }

        async function saveSet() {
            const name = document.getElementById('new-name').value;
            const color = document.getElementById('new-color').value;
            await fetch('/api/update_profile', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({display_name: name, color: color})
            });
            location.reload();
        }

        document.getElementById('message-input').onkeypress = (e) => {
            if(e.key === 'Enter' && e.target.value.trim()){
                socket.emit('message', {content: e.target.value});
                e.target.value = '';
            }
        };

        socket.on('message', async (data) => {
            const div = document.createElement('div');
            div.className = 'msg-line'; div.id = `msg-${data.id}`;
            const del = (userRole === 'admin' || userRole === 'owner') ? `<i class="fas fa-trash del-btn" onclick="deleteMsg(${data.id})"></i>` : '';
            div.innerHTML = `<span style="color:${data.color}; font-weight:bold;">${data.display_name}:</span> <span id="txt-${data.id}">${data.content}</span>${del}`;
            document.getElementById('messages').appendChild(div);
            
            if(data.content.includes('http')) fetchPreview(data.content, `txt-${data.id}`);
            if(!muted && data.display_name !== "{{current_user.display_name}}") document.getElementById('notif').play();
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        });

        async function fetchPreview(text, id) {
            const url = text.match(/(https?:\/\/[^\s]+)/g)[0];
            const res = await fetch(`/api/link-preview?url=${encodeURIComponent(url)}`);
            const d = await res.json();
            if(d.title) {
                document.getElementById(id).innerHTML += `<a href="${url}" target="_blank" class="preview-card">${d.image ? `<img src="${d.image}">`:''}<div class="preview-info"><b>${d.title}</b></div></a>`;
            }
        }

        function deleteMsg(id) { socket.emit('delete_message', {id: id}); }
        socket.on('message_deleted', (d) => document.getElementById(`msg-${d.id}`)?.remove());
        function clearChat() { if(confirm("Clear All?")) socket.emit('clear_chat'); }
        socket.on('chat_cleared', () => document.getElementById('messages').innerHTML = '');

        setInterval(() => {
            document.getElementById('t_dj').innerText = document.getElementById('sonic_dj').innerText || 'Auto DJ';
            document.getElementById('t_title').innerText = document.getElementById('sonic_title').innerText || 'Radio Parea';
            document.getElementById('t_listeners').innerText = document.getElementById('sonic_listeners').innerText.replace(/\D/g,'') || '0';
        }, 3000);
    </script>
</body>
</html>