<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Parea - Merry Christmas ğŸ”¥ğŸ„</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Orbitron:wght@700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        :root {
            --gold: #D4AF37;
            --fire: #ff4400;
            --red: #ff4444;
        }

        body {
    background-color: #050a14;
    margin: 0;
    /* Î‘Î›Î›Î‘Î“Î—: Î’Î³Î¬Î¶Î¿Ï…Î¼Îµ Ï„Î¿ height: 100vh ÎºÎ±Î¹ Ï„Î¿ overflow: hidden */
    min-height: 100vh; 
    display: flex;
    flex-direction: column;
    overflow-y: auto; /* Î•Ï€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ Ï„Î¿ ÏƒÎºÏÎ¿Î»Î¬ÏÎ¹ÏƒÎ¼Î± Ï€ÏÎ¿Ï‚ Ï„Î± ÎºÎ¬Ï„Ï‰ */
    overflow-x: hidden;
    font-family: 'Roboto', sans-serif;
}

        /* SNOW LAYER */
        #snowCanvas { 
    pointer-events: none !important; 
    z-index: 1; 
}


        .snow { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            pointer-events: none; 
            z-index: -1; 
        }

        /* HEADER */
        .header {
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--gold);
            z-index: 1000;
            min-height: 125px;
        }

        #sonic_dj { 
            font-family: 'Orbitron';
            font-size: 1.5em !important;
            font-weight: bold; 
            color: var(--gold) !important;
            text-transform: uppercase;
            text-shadow: 0 0 10px var(--fire), 0 0 20px var(--fire);
            animation: text-flicker 0.1s infinite alternate;
        }

        @keyframes text-flicker { from { opacity: 0.8; } to { opacity: 1; text-shadow: 0 0 20px var(--fire), 2px 2px 5px #000; } }

        .player-frame { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            background: rgba(0,0,0,0.8); 
            padding: 10px 25px; 
            border-radius: 60px; 
            border: 2px solid var(--gold); 
            position: relative; 
            box-shadow: 0 0 25px var(--fire); 
        }

        .flame-wrapper { position: absolute; bottom: -8px; width: 100%; height: 15px; display: flex; justify-content: center; }
        .flame { width: 18px; height: 18px; background: var(--fire); border-radius: 50% 0 50% 50%; transform: rotate(-45deg); animation: burn 0.4s infinite alternate; filter: blur(1px); opacity: 0.8; margin: 0 2px; }
        @keyframes burn { from { transform: rotate(-45deg) scale(1); } to { transform: rotate(-45deg) scale(1.4) translateY(-8px); } }

        #dj_profile img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--gold); box-shadow: 0 0 20px var(--gold); object-fit: cover; }

        /* CHAT WINDOW & MESSAGES (TRANSPARENT) */
        /* ÎœÎ¹ÎºÏÎ¬ ÎºÎ±Î¹ Î¿Î¼Î¿Î¹ÏŒÎ¼Î¿ÏÏ†Î± avatar ÏƒÏ„Î¿ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ */
.message-avatar {
    width: 30px !important;
    height: 30px !important;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 8px;
    vertical-align: middle;
    border: 1px solid var(--gold);
}

/* Î£Ï„Ï…Î» Î³Î¹Î± Ï„Î·Î½ ÏÏÎ± ÎºÎ±Î¹ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± */
.msg-time {
    font-size: 0.7em;
    color: #888;
    margin-left: 10px;
    white-space: pre; /* Î“Î¹Î± Î½Î± ÎºÏÎ±Ï„Î¬ÎµÎ¹ Ï„Î± ÎºÎµÎ½Î¬ Ï€Î¿Ï… Î¶Î®Ï„Î·ÏƒÎµÏ‚ */
}

/* Î“Î¹Î± Î½Î± Î¼Î·Î½ ÏƒÏ€Î¬ÎµÎ¹ Ï„Î¿ chat Î±Ï€ÏŒ Î¼ÎµÎ³Î¬Î»ÎµÏ‚ Î»Î­Î¾ÎµÎ¹Ï‚ */
.message-content {
    word-break: break-word;
}



.main { 
    display: flex !important; 
    flex-direction: row !important; /* Î‘Î½Î±Î³ÎºÎ¬Î¶ÎµÎ¹ Sidebar ÎºÎ±Î¹ Chat Î½Î± ÎµÎ¯Î½Î±Î¹ ÏƒÏ„Î·Î½ Î¯Î´Î¹Î± ÎµÏ…Î¸ÎµÎ¯Î± */
    width: 100%; 
    max-width: 100vw;
    height: 800px; /* Î‰ ÏŒÏƒÎ¿ ÏÏˆÎ¿Ï‚ Î¸Î­Î»ÎµÎ¹Ï‚ */
    margin: 0;
    padding: 0;
    overflow: hidden;
}

#chat-window { 
    flex: 1; /* Î Î±Î¯ÏÎ½ÎµÎ¹ ÏŒÎ»Î¿ Ï„Î¿Î½ ÎµÎ»ÎµÏÎ¸ÎµÏÎ¿ Ï‡ÏÏÎ¿ Î±ÏÎ¹ÏƒÏ„ÎµÏÎ¬ */
    display: flex; 
    flex-direction: column; 
    height: 100%;
}
#chat-box {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background-image: url('/static/radioparea.png') !important;
    background-size: contain !important; /* Î‘Î»Î»Î¬Î¶Î¿Ï…Î¼Îµ Ï„Î¿ cover ÏƒÎµ contain Î³Î¹Î± Î½Î± Î¼Î·Î½ "Î¼Ï€Î¿Ï…ÎºÏÎ½ÎµÎ¹" */
    background-position: center !important;
    background-repeat: no-repeat !important;
    background-color: #050a14 !important;
    border: 1px solid rgba(212, 175, 55, 0.3);
}
        .message { 
            background: transparent !important; /* Î•Î¾Î±Ï†Î¬Î½Î¹ÏƒÎ· Î³ÎºÏÎ¹ Î¼Ï€Î¬ÏÎ±Ï‚ */
            border: none !important; 
            padding: 8px 0px; 
            margin-bottom: 5px;
            color: white !important;
            /* Î ÎµÏÎ¯Î³ÏÎ±Î¼Î¼Î± ÏƒÏ„Î± Î³ÏÎ¬Î¼Î¼Î±Ï„Î± Î³Î¹Î± Î½Î± Ï†Î±Î¯Î½Î¿Î½Ï„Î±Î¹ Ï€Î±Î½Ï„Î¿Ï */
            text-shadow: 2px 2px 4px #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000 !important;
            font-size: 1.1em;
        }

        /* INPUT AREA */
        .input-area { 
            background: rgba(0, 0, 0, 0.85); 
            padding: 15px; 
            border-top: 2px solid var(--gold);
            z-index: 10;
        }
        

        .toolbar { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; flex-wrap: wrap; }
        
        #chat-input { 
            flex: 1; 
            padding: 15px; 
            border-radius: 15px; 
            border: 2px solid var(--gold); 
            background: #111; 
            color: white; 
            outline: none; 
            min-height: 45px; 
            font-size: 1.2em; 
        }

        .tool-btn { background: rgba(212,175,55,0.1); border: 1px solid var(--gold); color: white; padding: 8px 14px; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: bold; }
        .tool-btn:hover { background: var(--gold); color: black; transform: scale(1.1); }
        .emoji-btn { font-size: 1.4em; }

        /* SIDEBAR */
.sidebar { 
    width: 200px !important; 
    min-width: 200px;
    height: 100%;
    background: rgba(0, 0, 0, 0.85); 
    border-left: 2px solid var(--gold); 
    display: flex;
    flex-direction: column;
}

#gif-picker {
    z-index: 9999 !important;
    display: none; /* Î‘ÏÏ‡Î¹ÎºÎ¬ ÎºÏÏ…Ï†ÏŒ */
    flex-direction: column;
}

#gif-results {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* 2 ÏƒÏ„Î®Î»ÎµÏ‚ */
    gap: 10px;
    padding: 10px;
}

.emoji-picker {
    z-index: 99999 !important;
}

#gif-results img {
    width: 100%;
    height: 100px;
    object-fit: cover;
    cursor: pointer;
    border-radius: 5px;
    transition: transform 0.2s;
}

#gif-results img:hover {
    transform: scale(1.05);
    border: 1px solid var(--gold);
}

        #user-list-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        /* SCROLLBAR */
        #chat-box::-webkit-scrollbar { width: 6px; }
        #chat-box::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); }
        #chat-box::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 10px; }

        /* MODAL */
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); }
        .modal-content { background: #111; margin: 10% auto; padding: 30px; border: 2px solid var(--gold); width: 320px; border-radius: 25px; color: white; box-shadow: 0 0 30px var(--gold); }
        
        input[type="text"], input[type="color"] { width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid var(--gold); background: #222; color: white; }
       
        </style>
</head>
<body>
    <canvas class="snow" id="snowCanvas"></canvas>
    
    <div class="header">
        <div style="display:flex; flex-direction:column; gap:8px;">
            {% if current_user.role == 'owner' %}
            <button onclick="clearChat()" style="background:#ff4444; color:white; border:none; padding:10px; cursor:pointer; border-radius:5px;">
                <i class="fas fa-trash"></i> Î£ÎšÎŸÎ¥Î Î‘
            </button>
            {% endif %}
            <button onclick="document.getElementById('setModal').style.display='block'" class="tool-btn"><i class="fas fa-user-circle"></i> Î Î¡ÎŸÎ¦Î™Î›</button>
            <a href="{{ url_for('logout') }}" class="tool-btn" style="color:var(--red); border-color:var(--red); text-decoration:none; text-align:center;"><i class="fas fa-power-off"></i> Î•ÎÎŸÎ”ÎŸÎ£</a>
        </div>

        <div class="player-frame">
            <div class="flame-wrapper">
                <div class="flame"></div><div class="flame"></div><div class="flame"></div><div class="flame"></div>
            </div>
            <button id="play-pause-btn" style="background:var(--gold); border:none; width:55px; height:55px; border-radius:50%; cursor:pointer; box-shadow: 0 0 15px var(--gold);">
                <i class="fas fa-play" id="play-icon" style="font-size: 1.5em;"></i>
            </button>
            <div style="text-align: center;">
                <div style="color:white; font-family:'Dancing Script'; font-size:1.8em; text-shadow: 0 0 15px var(--fire);">Radio Parea ğŸ…</div>
                <input type="range" id="volume-control" min="0" max="1" step="0.1" value="0.5" style="accent-color:var(--gold); width:90px; cursor: pointer;">
            </div>
            <div style="text-align: left; min-width: 120px;">
                <div id="sonic_title" style="color:var(--gold); font-size: 0.8em; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Radio Parea Live</div>
                <div id="sonic_dj">DJ ON AIR</div>
            </div>
        </div>

        <div style="text-align:center;">
            <div id="dj_profile"></div>
            <div style="color:var(--gold); font-size:0.8em; margin-top:8px; font-weight:bold; font-family: 'Orbitron';">AKPOATEÎ£: <span id="sonic_listeners">0</span></div>
        </div>
    </div>

<div class="main">
        <div id="chat-window"> 
            
            <div id="chat-box">
                {% for msg in history %}
                <div class="message" id="msg-{{ msg.id }}" style="margin-bottom: 12px; display: flex; align-items: flex-start; gap: 10px;">
                    <img src="{{ msg.author.avatar_url or 'https://ui-avatars.com/api/?name=' + msg.author.display_name }}" class="message-avatar" style="width:35px; height:35px; border-radius:50%; border:1px solid var(--gold);">
                    <div style="display: flex; flex-direction: column;">
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <strong style="color: {{ msg.author.color }}; font-size: 0.9em;">{{ msg.author.display_name }}:</strong>
                            <span class="msg-time">{{ msg.timestamp.strftime("%H:%M   %d.%m.%Y") }}</span>
                            <i class="fas fa-edit" onclick="editMsg({{ msg.id }})" style="cursor:pointer; font-size:0.7em; color:gray; margin-left:5px;"></i>
                            {% if current_user.role in ['admin', 'owner'] %}
                            <i class="fas fa-trash" onclick="deleteMsg({{ msg.id }})" style="cursor:pointer; font-size:0.7em; color:red; margin-left:5px;"></i>
                            {% endif %}
                        </div>
                        <span class="message-content" style="color: white; text-shadow: 1px 1px 2px black;">{{ msg.content | safe }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="input-area">
    <div id="gif-picker" style="display:none; position:absolute; bottom:160px; left:20px; background:#000; border:2px solid var(--gold); border-radius:15px; width:300px; height:400px; z-index:9999; padding:10px; flex-direction:column;">
        <input type="text" id="gif-search" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· GIF..." onkeyup="searchGifs(this.value)" style="width:92%; padding:8px; background:#222; color:white; border:1px solid var(--gold); margin-bottom:10px;">
        <div id="gif-results" style="overflow-y:auto; display:grid; grid-template-columns: 1fr 1fr; gap:5px;"></div>
    </div>

    <div class="toolbar">
        <button type="button" class="tool-btn" onclick="document.getElementById('chat-input').focus(); document.execCommand('bold')"><b>B</b></button>
<button type="button" class="tool-btn" onclick="document.getElementById('chat-input').focus(); document.execCommand('italic')"><i>I</i></button>
        <input type="color" onchange="document.execCommand('foreColor', false, this.value)" style="width:30px; height:30px; cursor:pointer; vertical-align:middle;">
        
        <button type="button" onclick="addEmoji('ğŸ…')" class="tool-btn">ğŸ…</button>
        <button type="button" onclick="addEmoji('ğŸ„')" class="tool-btn">ğŸ„</button>
        <button type="button" onclick="addEmoji('ğŸ')" class="tool-btn">ğŸ</button>
        <button type="button" onclick="addEmoji('ğŸ””')" class="tool-btn">ğŸ””</button>
        <button type="button" onclick="addEmoji('â„ï¸')" class="tool-btn">â„ï¸</button>
        <button type="button" onclick="addEmoji('ğŸ”¥')" class="tool-btn">ğŸ”¥</button>
        <button type="button" onclick="addEmoji('ğŸ¶')" class="tool-btn">ğŸ¶</button>
        <button type="button" onclick="addEmoji('â­')" class="tool-btn">â­</button>
        
        <button type="button" id="emoji-trigger" class="tool-btn">ğŸ˜Š</button>
       
       <div id="custom-emoji-picker" style="display:none; position: absolute; bottom: 85px; left: 10px; background: rgba(15, 15, 15, 0.98); border: 2px solid var(--gold); border-radius: 20px; padding: 15px; width: 280px; z-index: 10001; box-shadow: 0 0 30px rgba(212, 175, 55, 0.4); backdrop-filter: blur(15px);">
    
    <div style="color: var(--gold); font-family: 'Orbitron'; font-size: 11px; margin-bottom: 12px; text-align: center; border-bottom: 1px solid rgba(212, 175, 55, 0.2); padding-bottom: 8px;">
        <i class="fas fa-headphones"></i> RADIO PAREA VIP
    </div>

    <div id="emoji-list" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; text-align: center; max-height: 220px; overflow-y: auto; padding-right: 5px;">
        </div>
</div>

<style>
    /* Styling Î³Î¹Î± Ï„Î¿ Scrollbar Ï„Î¿Ï… Emoji Picker */
    #emoji-list::-webkit-scrollbar { width: 4px; }
    #emoji-list::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
    #emoji-list::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 10px; }
</style>
<button type="button" class="tool-btn ignore-emoji" onclick="toggleGifPicker(event)">GIF</button>
    </div>
<div class="style-options-bar" style="display: flex; gap: 10px; margin: 10px 0; padding: 5px; background: rgba(255,255,255,0.05); border-radius: 8px;">
    <select id="text-font" style="background:#000; color:#d4af37; border:1px solid #d4af37; font-size:12px; border-radius:4px; cursor:pointer;">
        <option value="inherit">Font</option>
        <option value="'Orbitron', sans-serif">Modern</option>
        <option value="'Dancing Script', cursive">Calligraphy</option>
    </select>

    <select id="text-size" style="background:#000; color:#d4af37; border:1px solid #d4af37; font-size:12px; border-radius:4px; cursor:pointer;">
        <option value="15px">S</option>
        <option value="20px" selected>M</option>
        <option value="28px">L</option>
    </select>

    <select id="text-effect" style="background:#000; color:#d4af37; border:1px solid #d4af37; font-size:12px; border-radius:4px; cursor:pointer;">
        <option value="none">Normal</option>
        <option value="marquee">Marquee</option>
    </select>
</div>

    <div style="display:flex; gap:10px; align-items: center;">
        <div id="chat-input" contenteditable="true" placeholder="Î“ÏÎ¬ÏˆÏ„Îµ ÎºÎ¬Ï„Î¹..."></div>
        <button onclick="sendMessage()" style="background:var(--gold); border:none; padding:10px 30px; border-radius:15px; font-weight:bold; cursor:pointer; height:50px; flex-shrink:0;">Î£Î¤Î•Î™Î›Î•</button>
    </div> </div> </div> <div class="sidebar" style="display: flex; flex-direction: column; background: rgba(0,0,0,0.5); border-left: 1px solid var(--gold); width: 250px; height: 100%;">
    <div style="color:var(--gold); font-weight:bold; padding: 15px 0; font-family: 'Orbitron'; text-align:center; border-bottom: 1px solid rgba(212,175,55,0.2);">
        <i class="fas fa-users"></i> ONLINE
    </div>

    <div id="user-list-content" style="flex: 1; overflow-y: auto; padding: 10px;"></div>

    <div style="padding: 15px 10px; border-top: 1px solid rgba(212,175,55,0.3); background: rgba(0,0,0,0.3);">
        <div style="color:var(--gold); font-weight:bold; margin-bottom: 8px; font-family: 'Orbitron'; text-align:center; font-size: 0.7em;">
            <i class="fas fa-info-circle"></i> INFO CENTER
        </div>
        
        <div onclick="document.getElementById('progModal').style.display='flex'" 
             style="cursor: pointer; position: relative; width: 100%; border: 1px solid var(--gold); border-radius: 8px; overflow: hidden; aspect-ratio: 16/9; box-shadow: 0 0 10px rgba(212,175,55,0.2);">
            
            <div style="position: absolute; top:0; left:0; width:100%; height:100%; z-index: 10;"></div>
            
            <iframe 
                src="https://docs.google.com/presentation/d/e/2PACX-1vSWKUdDqxVATw0zJ3dhv9itmtduJhmEBG1xCRthIoO7881_ex7OXANm7aEeEuCd9A/embed?start=true&loop=true&delayms=5000&rm=minimal" 
                frameborder="0" 
                style="width: 100%; height: 100%; pointer-events: none;" 
                allowfullscreen="true">
            </iframe>
            
            <div style="position: absolute; bottom: 0; width: 100%; background: rgba(212,175,55,0.9); color: black; text-align: center; font-size: 9px; font-weight: bold; z-index: 11; padding: 2px 0;">
                ÎšÎ›Î™Îš Î“Î™Î‘ ÎœÎ•Î“Î•Î˜Î¥ÎÎ£Î—
            </div>
        </div>
    </div>
</div>


    <div id="setModal" class="modal" style="{% if not current_user.has_setup_profile %} display:block; backdrop-filter: blur(15px); {% endif %}">
    <div class="modal-content" style="border: 2px solid var(--fire); box-shadow: 0 0 30px var(--fire);">
        <h3 style="text-align:center; color:var(--gold); font-family:'Orbitron';">
            {% if not current_user.has_setup_profile %} ÎšÎ‘Î›Î©Î£Î—Î¡Î˜Î•Î£! Î¦Î¤Î™Î‘ÎÎ• Î¤ÎŸ Î Î¡ÎŸÎ¦Î™Î› Î£ÎŸÎ¥ {% else %} Î¡Î¥Î˜ÎœÎ™Î£Î•Î™Î£ {% endif %}
        </h3>
        
        <label>ÎŒÎ½Î¿Î¼Î± (Nickname):</label>
<input type="text" id="new-nickname" value="{{ current_user.display_name }}" 
       {% if current_user.has_setup_profile %} readonly style="background: #222; color: #777; cursor: not-allowed;" {% endif %} 
       placeholder="Î“ÏÎ¬ÏˆÎµ Ï„Î¿ ÏŒÎ½Î¿Î¼Î¬ ÏƒÎ¿Ï…...">
{% if current_user.has_setup_profile %}
<p style="color: gray; font-size: 0.8em; margin-top: -5px;">Î¤Î¿ ÏŒÎ½Î¿Î¼Î± ÎµÎ¯Î½Î±Î¹ ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Î¿. ÎœÏ€Î¿ÏÎµÎ¯Ï‚ Î½Î± Î±Î»Î»Î¬Î¾ÎµÎ¹Ï‚ Î¼ÏŒÎ½Î¿ Ï‡ÏÏÎ¼Î± ÎºÎ±Î¹ ÎµÎ¹ÎºÏŒÎ½Î±.</p>
{% endif %}
        
        <label>Avatar URL (Link ÎµÎ¹ÎºÏŒÎ½Î±Ï‚):</label>
        <input type="text" id="new-avatar" value="{{ current_user.avatar_url or '' }}" placeholder="https://link.to-your-image.png">
        
        <label>Î§ÏÏÎ¼Î± ÎŸÎ½ÏŒÎ¼Î±Ï„Î¿Ï‚ ÏƒÏ„Î¿ Chat:</label>
        <input type="color" id="new-color" value="{{ current_user.color or '#D4AF37' }}">
        
        <button onclick="saveProfile()" style="width:100%; background:var(--gold); border:none; padding:15px; margin-top:10px; cursor:pointer; font-weight:bold; border-radius:10px; font-size:1.1em;">Î‘Î ÎŸÎ˜Î—ÎšÎ•Î¥Î£Î— & Î•Î™Î£ÎŸÎ”ÎŸÎ£</button>
        
        {% if current_user.has_setup_profile %}
        <button onclick="document.getElementById('setModal').style.display='none'" style="width:100%; background:none; color:gray; border:none; margin-top:10px; cursor:pointer;">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
        {% endif %}
    </div>
</div>

    <script id='sonic_js' data-port='8050' src='https://or.mysonicserver.com/cp/widgets.js?r=381'></script>
    <script>
        const socket = io();
        const chatInput = document.getElementById('chat-input');
        const chatBox = document.getElementById('chat-box');



socket.on("message", function(data) {
    const currentUserId = parseInt('{{ current_user.id }}');
    const currentUserRole = '{{ current_user.role }}';
    const currentUsername = '{{ current_user.display_name }}'; 
    const chatBox = document.getElementById('chat-box');

    const msgDiv = document.createElement('div');
    msgDiv.className = 'message';
    msgDiv.id = `msg-${data.id}`;
    msgDiv.style = "margin-bottom: 12px; display: flex; align-items: flex-start; gap: 10px; transition: background 0.3s; padding: 5px; border-radius: 8px;";

    // --- Î§Î•Î™Î¡ÎŸÎ¥Î¡Î“Î™ÎšÎ— Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—: MENTIONS ---
    // Î‘Î½ Ï„Î¿ Ï€ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿ Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ Ï„Î¿ @ÎŒÎ½Î¿Î¼Î¬Î£Î¿Ï…, Î¬Î»Î»Î±Î¾Îµ Ï„Î¿ Ï†ÏŒÎ½Ï„Î¿
    if (data.content.includes('@' + currentUsername)) {
        msgDiv.style.backgroundColor = "rgba(212, 175, 55, 0.2)"; // Î§ÏÏ…ÏƒÎ±Ï†Î¯ Î´Î¹Î±Ï†Î±Î½Î­Ï‚
        msgDiv.style.borderLeft = "4px solid var(--gold)";
        msgDiv.style.paddingLeft = "8px";
    }

    const finalContent = processMessageContent(data.content);
    const rawText = data.content.replace(/<\/?[^>]+(>|$)/g, "");

    // --- ÎŸÎ›Î‘ Î¤Î‘ ACTIONS ÎœÎ‘Î–Î™ ---
    let actions = `<span class="msg-time">${data.timestamp}</span>`;
    
    // 1. Reply (Î¤Î¿ Î²ÎµÎ»Î¬ÎºÎ¹ Î³Î¹Î± ÏŒÎ»Î¿Ï…Ï‚)
    actions += ` <i class="fas fa-reply" onclick="replyTo('${data.display_name}')" style="cursor:pointer; font-size:0.7em; color:var(--gold); margin-left:8px;" title="Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ·"></i>`;

    // 2. Edit (ÎœÏŒÎ½Î¿ Î´Î¹ÎºÎ¬ ÏƒÎ¿Ï… Î® Admin)
    if (data.user_id === currentUserId || currentUserRole !== "user") {
        actions += ` <i class="fas fa-edit" onclick="editMsg(${data.id})" style="cursor:pointer; font-size:0.7em; color:gray; margin-left:5px;"></i>`;
    }
    
    // 3. Delete (ÎœÏŒÎ½Î¿ Admin/Owner)
    if (currentUserRole !== "user") {
        actions += ` <i class="fas fa-trash" onclick="deleteMsg(${data.id})" style="cursor:pointer; font-size:0.7em; color:red; margin-left:5px;"></i>`;
    }

    msgDiv.innerHTML = `
        <img src="${data.avatar_url}" class="message-avatar" style="width:35px; height:35px; border-radius:50%; border:1px solid var(--gold); object-fit:cover;">
        <div style="display: flex; flex-direction: column;">
            <div style="display: flex; align-items: baseline; gap: 8px;">
                <strong style="color: ${data.color}; font-size: 0.9em;">${data.display_name}:</strong>
                ${actions}
            </div>
            <span class="message-content" data-raw-content="${rawText}" style="color: white; text-shadow: 1px 1px 2px black;">${finalContent}</span>
        </div>
    `;

    chatBox.appendChild(msgDiv);
    
    // Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î¿ Scroll ÏƒÏ„Î¿ Ï„Î­Î»Î¿Ï‚
    chatBox.scrollTop = chatBox.scrollHeight;
});


// Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚ ÏƒÏ„Î¿ Ï„Î­Î»Î¿Ï‚ Ï„Î¿Ï… script
function deleteMsg(id) {
    if(confirm("Î”Î¹Î±Î³ÏÎ±Ï†Î® Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚;")) socket.emit("delete_message", {id: id});
}

function replyTo(username) {
    const chatInput = document.getElementById('chat-input');
    
    // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¿ÏÎ¼Îµ Ï„Î¿ HTML Î³Î¹Î± Ï„Î¿ mention
    const mention = `<strong style="color:var(--gold);">@${username}</strong>&nbsp;`;
    
    // Î¤Î¿ Î²Î¬Î¶Î¿Ï…Î¼Îµ ÏƒÏ„Î¿ input ÎºÎ±Î¹ Î´Î¯Î½Î¿Ï…Î¼Îµ focus
    chatInput.innerHTML = mention + chatInput.innerHTML;
    chatInput.focus();

    // Î§ÎµÎ¹ÏÎ¿Ï…ÏÎ³Î¹ÎºÎ® ÎºÎ¯Î½Î·ÏƒÎ·: Î Î·Î³Î±Î¯Î½Î¿Ï…Î¼Îµ Ï„Î¿Î½ ÎºÎ­ÏÏƒÎ¿ÏÎ± ÏƒÏ„Î¿ Ï„Î­Î»Î¿Ï‚
    const range = document.createRange();
    const sel = window.getSelection();
    range.selectNodeContents(chatInput);
    range.collapse(false);
    sel.removeAllRanges();
    sel.addRange(range);
}

function editMsg(id) {
    // Î’ÏÎ¯ÏƒÎºÎ¿Ï…Î¼Îµ Ï„Î¿ Î¼Î®Î½Ï…Î¼Î± ÏƒÏ„Î· Î²Î¬ÏƒÎ· Ï„Ï‰Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ (Ï„Î¿ Î±ÏÏ‡Î¹ÎºÏŒ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ Ï€Î¿Ï… Î­ÏƒÏ„ÎµÎ¹Î»Îµ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚)
    const el = document.querySelector(`#msg-${id} .message-content`);
    if (!el) return;

    // Î£Î·Î¼Î±Î½Ï„Î¹ÎºÏŒ: Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Ï„Î¿ textContent Î³Î¹Î± Î½Î± Î¼Î·Î½ Ï€Î¬ÏÎ¿Ï…Î¼Îµ Ï„Î± <img> tags
    // Î±Î»Î»Î¬ Ï„Î¿ Link Ï€Î¿Ï… ÎºÏÏÎ²ÎµÏ„Î±Î¹ Î±Ï€ÏŒ Ï€Î¯ÏƒÏ‰ Î±Î½ ÎµÎ¯Î½Î±Î¹ ÎµÎ¹ÎºÏŒÎ½Î±.
    const oldContent = el.getAttribute('data-raw-content') || el.innerText; 
    
    const newText = prompt("Î”Î¹ÏŒÏÎ¸Ï‰ÏƒÎ· Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚ Î® Link ÎµÎ¹ÎºÏŒÎ½Î±Ï‚:", oldContent);
    
    if(newText !== null && newText.trim() !== "") {
        socket.emit("edit_message", {id: id, new_content: newText});
    }
}


socket.on("message_deleted", data => {
    const msgToRem = document.getElementById(`msg-${data.id}`);
    if(msgToRem) msgToRem.remove();
});

socket.on("message_edited", data => {
    const el = document.querySelector(`#msg-${data.id} .message-content`);
    if(el) el.innerHTML = processMessageContent(data.content);
});

socket.on('clear_chat_client', () => {
    const chatBox = document.getElementById('chat-box');
    if (chatBox) chatBox.innerHTML = '';
});

        socket.on('update_bg', (data) => {
            if (data.url) {
                document.body.style.backgroundImage = `url('${data.url}')`;
            }
        });

        function addEmoji(e) { chatInput.innerHTML += e; chatInput.focus(); }

        const radio = new Audio('https://or.mysonicserver.com:8050/;');
        radio.volume = 0.5;
        document.getElementById('play-pause-btn').onclick = () => {
            if (radio.paused) { radio.play(); document.getElementById('play-icon').className = 'fas fa-pause'; }
            else { radio.pause(); document.getElementById('play-icon').className = 'fas fa-play'; }
        };
        document.getElementById('volume-control').oninput = function() { radio.volume = this.value; };

        // SNOW EFFECT
        const canvas = document.getElementById('snowCanvas'); const ctx = canvas.getContext('2d'); let particles = [];
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = resize; resize();

        function draw() {
            ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle = "white"; ctx.beginPath();
            if(particles.length < 150) particles.push({x:Math.random()*canvas.width, y:-10, r:Math.random()*3+1, d:Math.random()*1.2});
            for(let p of particles) { ctx.moveTo(p.x, p.y); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); p.y += 1 + p.d; if(p.y > canvas.height) p.y = -10; }
            ctx.fill(); requestAnimationFrame(draw);
        }
        draw();



        function clearChat() { 
            if(confirm("Î˜Î­Î»ÎµÏ„Îµ Î½Î± ÎºÎ±Î¸Î±ÏÎ¯ÏƒÎµÏ„Îµ Ï„Î¿ chat; Î— ÏƒÎºÎ¿ÏÏ€Î± Î¸Î± Ï€ÎµÏÎ¬ÏƒÎµÎ¹! âœ¨")) {
                socket.emit('clear_chat_request');
            }
        }



function processMessageContent(content) {
    if (!content) return "";
    
    let html = content;
    // Regex Ï€Î¿Ï… Î±Î½Î±Î³Î½Ï‰ÏÎ¯Î¶ÎµÎ¹ Î¼ÏŒÎ½Î¿ ÎºÎ±Î¸Î±ÏÎ¬ links ÎµÎ¹ÎºÏŒÎ½Ï‰Î½
    const imgRegex = /(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp))/gi;
    const ytRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/g;

    // ÎœÎµÏ„Î±Ï„ÏÎ¿Ï€Î® ÎµÎ¹ÎºÏŒÎ½Ï‰Î½: Î•Î»Î­Î³Ï‡Î¿Ï…Î¼Îµ Î±Î½ Ï„Î¿ link ÎµÎ¯Î½Î±Î¹ Î®Î´Î· Î¼Î­ÏƒÎ± ÏƒÎµ src Î³Î¹Î± Î½Î± Î¼Î·Î½ Ï„Î¿ Î¾Î±Î½Î±Ï†Ï„Î¹Î¬Î¾Î¿Ï…Î¼Îµ
    html = html.replace(imgRegex, (match) => {
        if (html.includes('src="' + match + '"')) return match; 
        return `<br><img src="${match}" style="max-width:100%; border-radius:10px; margin-top:10px; border: 2px solid var(--gold);">`;
    });

    // ÎœÎµÏ„Î±Ï„ÏÎ¿Ï€Î® YouTube
    html = html.replace(ytRegex, (u, id) => {
        return `<br><iframe width="100%" height="250" src="https://www.youtube.com/embed/${id}" frameborder="0" allowfullscreen style="border-radius:15px; border: 2px solid var(--fire);"></iframe>`;
    });
    
    return html;
}
        // Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚
        function sendMessage() {
            const content = chatInput.innerHTML.trim();
            if(content && content !== '<br>') { 
                socket.emit('message', { content: content }); 
                chatInput.innerHTML = ''; 
            }
        }


        socket.on('users_update', (users) => {
            const userList = document.getElementById('user-list-content');
            if (userList) {
                userList.innerHTML = users.map(u => `
                    <div style="margin-bottom:15px; display:flex; flex-direction:column; align-items:center;">
                        <img src="${u.avatar_url || 'https://i.imgur.com/6VBx3io.png'}" style="width:50px; height:50px; border-radius:50%; border:2px solid ${u.color}; object-fit:cover;">
                        <div style="color:${u.color}; font-size:0.85em; font-weight:bold; margin-top:5px; text-shadow: 1px 1px 2px #000;">${u.display_name}</div>
                    </div>`).join('');
            }
        });

function saveProfile() {
    const nick = document.getElementById('new-nickname').value;
    const av = document.getElementById('new-avatar').value;
    const col = document.getElementById('new-color').value;

    if (!nick || nick.trim() === "") {
        alert("Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Î²Î¬Î»ÎµÎ¹Ï‚ Î­Î½Î± ÏŒÎ½Î¿Î¼Î±!");
        return;
    }

    const data = {
        display_name: nick,
        avatar_url: av || "https://i.imgur.com/6VBx3io.png",
        color: col
    };

    fetch('/update_profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(res => {
        if (res.status === "success") {
            document.getElementById('setModal').style.display = 'none';
            window.location.reload(); 
        } else {
            alert(res.message);
        }
    });
}


        chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

        // Î”Î¹ÏŒÏÎ¸Ï‰ÏƒÎ· Î™ÏƒÏ„Î¿ÏÎ¹ÎºÎ¿Ï ÎºÎ±Ï„Î¬ Ï„Î¿ Ï†ÏŒÏÏ„Ï‰Î¼Î± (Refresh)
        window.addEventListener('load', () => { 
            document.querySelectorAll('.message-content').forEach(span => {
                span.innerHTML = processMessageContent(span.innerHTML);
            });
            chatBox.scrollTop = chatBox.scrollHeight; 
        });
// Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Î³Î¹Î± Ï„Î·Î½ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î· ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Î·Ï‚ ÎµÎ¹ÎºÏŒÎ½Î±Ï‚ Ï„Î¿Ï… DJ
function updateDJImage() {
    const djProfileDiv = document.getElementById('dj_profile');
    // Î¤Î¿ widget Ï„Î·Ï‚ SonicPanel Î±Ï€Î¿Î¸Î·ÎºÎµÏÎµÎ¹ Ï„Î·Î½ ÎµÎ¹ÎºÏŒÎ½Î± ÏƒÎµ Î¼Î¹Î± Ï€Î±Î³ÎºÏŒÏƒÎ¼Î¹Î± Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î® Î® ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î¿
    // Î”Î¿ÎºÎ¹Î¼Î¬Î¶Î¿Ï…Î¼Îµ Î½Î± Ï€Î¬ÏÎ¿Ï…Î¼Îµ Ï„Î·Î½ ÎµÎ¹ÎºÏŒÎ½Î± Î±Ï€ÏŒ Ï„Î¿ sonic_js widget
    const internalDJImg = document.querySelector('.sonic_dj_picture img'); 
    
    if (internalDJImg && djProfileDiv) {
        djProfileDiv.innerHTML = `<img src="${internalDJImg.src}" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--gold); box-shadow: 0 0 20px var(--gold); object-fit: cover;">`;
    }
}
setInterval(updateDJImage, 5000);
</script>

<script>
// ==========================================
// 1. Î›Î•Î™Î¤ÎŸÎ¥Î¡Î“Î™Î‘ GIF (GIPHY API)
// ==========================================
function sendGif(url) {
    if (url) {
        const cleanUrl = url.split('&')[0].split('?')[0]; // ÎšÎ±Î¸Î±ÏÎ¯Î¶ÎµÎ¹ Ï„Î¿ &ct=g
        socket.emit('message', { content: cleanUrl });
        document.getElementById('gif-picker').style.display = 'none';
        document.getElementById('gif-search').value = ''; 
    }
}

async function searchGifs(term = "") {
    const apiKey = "UQxRacYoTn67CWCJ5zbdOvUnzmU0QnUs"; 
    const endpoint = term.trim() === "" ? "trending" : "search";
    const url = `https://api.giphy.com/v1/gifs/${endpoint}?api_key=${apiKey}&q=${encodeURIComponent(term)}&limit=12&rating=g`;
    
    try {
        const res = await fetch(url);
        const data = await res.json();
        const resultsDiv = document.getElementById('gif-results');
        if (data && data.data) {
            resultsDiv.innerHTML = data.data.map(g => 
               `<img src="${g.images.fixed_height_small.url}" onclick="sendGif('${g.images.original.url}')" style="width:100%; height:90px; object-fit:cover; cursor:pointer; border-radius:8px;">`
            ).join('');
        }
    } catch (e) { console.error("Giphy Error:", e); }
}

function toggleGifPicker(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    const gp = document.getElementById('gif-picker');
    const isVisible = (gp.style.display === 'flex');
    gp.style.display = isVisible ? 'none' : 'flex';
    if (!isVisible) searchGifs(""); 
}

// ==========================================
// 2. Î›Î•Î™Î¤ÎŸÎ¥Î¡Î“Î™Î‘ EMOJIS (ğŸ˜Š)
// ==========================================
function initEmojiPicker() {
    const emojiBtn = document.getElementById('emoji-trigger');
    const picker = document.getElementById('custom-emoji-picker');
    const emojiList = document.getElementById('emoji-list');
    const inputField = document.getElementById('chat-input');

    if (!emojiBtn || !picker) return;

    fetch('/static/emoticons.html')
        .then(response => response.text())
        .then(html => {
            emojiList.innerHTML = html;
            
            // Î•Î´Ï Ï€Î¹Î¬Î½Î¿Ï…Î¼Îµ ÏŒÎ»Î± Ï„Î± spans Ï€Î¿Ï… Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎ±Î½
            emojiList.querySelectorAll('.emoji-item').forEach(el => {
                el.onclick = function() {
                    const gifUrl = this.getAttribute('data-gif');
                    
                    if (gifUrl) {
                        // Î‘Î Î•Î™ÎÎ‘Î™ GIF: Î¤Î¿ ÏƒÏ„Î­Î»Î½ÎµÎ¹ ÎºÎ±Ï„ÎµÏ…Î¸ÎµÎ¯Î±Î½ ÏƒÏ„Î¿ chat
                        socket.emit('message', { content: gifUrl });
                        picker.style.display = 'none'; // ÎšÎ»ÎµÎ¯Î½ÎµÎ¹ Ï„Î¿ Ï€Î±ÏÎ¬Î¸Ï…ÏÎ¿
                    } else {
                        // Î‘Î Î•Î™ÎÎ‘Î™ EMOJI: Î¤Î¿ Î²Î¬Î¶ÎµÎ¹ ÏƒÏ„Î¿ ÎºÎ¿Ï…Ï„Î¯ Ï€Î¿Ï… Î³ÏÎ¬Ï†ÎµÎ¹Ï‚
                        inputField.innerHTML += this.innerText;
                        inputField.focus();
                        
                        // ÎšÏÎ´Î¹ÎºÎ±Ï‚ Î³Î¹Î± Î½Î± Ï€Î¬ÎµÎ¹ Î¿ ÎºÎ­ÏÏƒÎ¿ÏÎ±Ï‚ ÏƒÏ„Î¿ Ï„Î­Î»Î¿Ï‚
                        const range = document.createRange();
                        const sel = window.getSelection();
                        range.selectNodeContents(inputField);
                        range.collapse(false);
                        sel.removeAllRanges();
                        sel.addRange(range);
                    }
                };
            }); // Î•Î´Ï Î­ÎºÎ»ÎµÎ¹Î½Îµ Ï„Î¿ ÏƒÏ†Î¬Î»Î¼Î±
        })
        .catch(err => console.error("Error loading emojis:", err));

    emojiBtn.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        const isHidden = (picker.style.display === 'none' || picker.style.display === '');
        picker.style.display = isHidden ? 'block' : 'none';
    };
}
// ==========================================
// 3. Î•ÎšÎšÎ™ÎÎ—Î£Î— & UPDATE
// ==========================================
document.addEventListener('DOMContentLoaded', () => {
    initEmojiPicker();

    document.addEventListener('click', (e) => {
        const gp = document.getElementById('gif-picker');
        const ep = document.getElementById('custom-emoji-picker');
        const progModal = document.getElementById('progModal');

        if (gp && gp.style.display === 'flex' && !gp.contains(e.target) && !e.target.classList.contains('ignore-emoji')) {
            gp.style.display = 'none';
        }
        if (ep && ep.style.display === 'block' && !ep.contains(e.target) && e.target.id !== 'emoji-trigger') {
            ep.style.display = 'none';
        }
        if (e.target === progModal) {
            progModal.style.display = "none";
        }
    });

    // ÎÎµÎºÎ¹Î½Î¬ÎµÎ¹ Î· Î±Î½Î±Î½Î­Ï‰ÏƒÎ· Ï„Î·Ï‚ ÎµÎ¹ÎºÏŒÎ½Î±Ï‚ DJ
    if (typeof updateDJImage === 'function') {
        setInterval(updateDJImage, 5000);
    }
});
</script>

<div id="progModal" style="display:none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); align-items: center; justify-content: center;">
    <div style="background: #111; border: 2px solid var(--gold); width: 90%; max-width: 900px; padding: 20px; border-radius: 15px; position: relative;">
        <span onclick="document.getElementById('progModal').style.display='none'" style="position: absolute; right: 20px; top: 10px; color: var(--gold); font-size: 35px; font-weight: bold; cursor: pointer;">&times;</span>
        <h2 style="color: var(--gold); font-family: 'Orbitron'; text-align: center; margin-bottom: 20px;">
            <i class="fas fa-calendar-alt"></i> Î Î¡ÎŸÎ“Î¡Î‘ÎœÎœÎ‘ Î¡Î‘Î”Î™ÎŸÎ Î‘Î¡Î•Î‘
        </h2>
        <div style="position: relative; width: 100%; height: 0; padding-bottom: 56.25%; border-radius: 10px; overflow: hidden;">
            <iframe src="https://docs.google.com/presentation/d/e/2PACX-1vSWKUdDqxVATw0zJ3dhv9itmtduJhmEBG1xCRthIoO7881_ex7OXANm7aEeEuCd9A/embed?start=true&loop=true&delayms=3000&rm=minimal" frameborder="0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" allowfullscreen="true"></iframe>
        </div>
    </div>
</div>
</body>
</html>