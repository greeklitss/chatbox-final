<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Parea - Live</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Orbitron:wght@700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        :root { --gold: #D4AF37; }
        body { 
            background: #000; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            background-size: cover !important; background-position: center center !important;
            background-repeat: no-repeat; background-attachment: fixed; transition: background 0.5s ease;
        }
        
        /* HEADER - PLAYER & METADATA */
        .header { background: rgba(0,0,0,0.85); padding: 10px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--gold); z-index: 1000; min-height: 120px; position: relative; }
        
        #sonic_dj { font-family: 'Orbitron'; color: #FFD700; text-shadow: 0 0 10px #ff4500; font-weight: bold; }
        
        #dj_profile img { 
            width: 85px !important; height: 85px !important; border-radius: 50% !important; 
            border: 3px solid var(--gold) !important; object-fit: contain !important;
            background: #111; box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        }

        .player-container { background: rgba(212, 175, 55, 0.1); padding: 15px 25px; border-radius: 50px; border: 1px solid rgba(212, 175, 55, 0.4); display: flex; align-items: center; gap: 15px; }

        /* Î¦Î©Î¤ÎŸÎ¡Î¥Î˜ÎœÎ™ÎšÎ‘ Î Î‘ÎÎ¤ÎŸÎ¥ */
        .spot { position: absolute; width: 250px; height: 250px; border-radius: 50%; filter: blur(80px); opacity: 0.2; animation: disco-flash 0.8s infinite alternate; z-index: 1; }
        .spot-1 { top: 20%; left: 10%; background: #ff0000; }
        .spot-2 { bottom: 20%; right: 10%; background: #0000ff; }
        @keyframes disco-flash { 0% { transform: scale(0.8); opacity: 0.1; } 100% { transform: scale(1.2); opacity: 0.3; } }

        .main { display: flex; flex: 1; overflow: hidden; position: relative; z-index: 5; }
        #chat-window { flex: 1; display: flex; flex-direction: column; background: rgba(0,0,0,0.1); backdrop-filter: blur(3px); }
        #chat-box { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 12px; }
        
        .message { background: rgba(20, 20, 20, 0.75); padding: 12px 18px; border-radius: 18px; border-left: 5px solid var(--gold); align-self: flex-start; max-width: 85%; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }

        /* Î•Î¡Î“Î‘Î›Î•Î™Î‘ Î“Î¡Î‘Î¦Î—Î£ */
        .input-area { background: rgba(0,0,0,0.92); padding: 15px; border-top: 2px solid var(--gold); }
        .toolbar { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; flex-wrap: wrap; }
        .emoji-bar { margin-bottom: 8px; border-bottom: 1px solid rgba(212,175,55,0.2); padding-bottom: 5px; }
        
        #chat-input { 
            flex: 1; padding: 15px; border-radius: 15px; border: 1px solid var(--gold); 
            background: #111; color: white; outline: none; min-height: 40px; white-space: pre-wrap;
        }
        #chat-input:empty:before { content: attr(placeholder); color: #777; font-style: italic; }

        .tool-btn { background: rgba(212,175,55,0.1); border: 1px solid var(--gold); color: white; padding: 6px 10px; border-radius: 5px; cursor: pointer; }
        .tool-btn.active { background: var(--gold); color: #000; }

        .sidebar { width: 190px; background: rgba(0,0,0,0.85); border-left: 2px solid var(--gold); padding-top: 20px; text-align: center; }
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); }
        .modal-content { background: #111; margin: 5% auto; padding: 25px; border: 1px solid var(--gold); width: 350px; border-radius: 20px; color: white; }
    </style>
</head>
<body>
    <div class="spot spot-1"></div><div class="spot spot-2"></div>

    <div class="header">
        <div style="display:flex; flex-direction:column; gap:8px;">
            <button onclick="document.getElementById('setModal').style.display='block'" class="tool-btn"><i class="fas fa-cog"></i></button>
            <a href="{{ url_for('logout') }}" class="tool-btn" style="color:#ff4d4d; border-color:#ff4d4d;"><i class="fas fa-power-off"></i></a>
        </div>
        
        <div class="player-container">
            <button id="play-pause-btn" style="background:var(--gold); border:none; width:45px; height:45px; border-radius:50%; cursor:pointer;"><i class="fas fa-play" id="play-icon"></i></button>
            <div style="text-align: left;">
                <div style="font-family:'Dancing Script'; font-size:1.5em; color:white;">Radio Parea <span id="sonic_dj"></span></div>
                <div id="sonic_title" style="font-size:0.8em; color:#ddd; font-weight:bold;">Î¦Î¿ÏÏ„ÏÎ½ÎµÎ¹...</div>
            </div>
            <input type="range" id="volume" min="0" max="1" step="0.1" value="0.5" style="width:50px; accent-color:var(--gold);">
        </div>

        <div style="text-align:center;">
            <div id="dj_profile"></div>
            <div style="color:var(--gold); font-size:0.75em; margin-top:5px;">LISTENERS: <span id="sonic_listeners">0</span></div>
        </div>
    </div>

    <div class="main">
        <div id="chat-window">
            <div id="chat-box">
                {% for msg in history %}
                <div class="message">
                    <b style="color:{{msg.author.color}}">{{msg.author.display_name}}</b><br>
                    <span>{{msg.content|safe}}</span>
                </div>
                {% endfor %}
            </div>

            <div class="input-area">
                <div class="emoji-bar">
                    <button onclick="addEmoji('ğŸ˜Š')" class="tool-btn">ğŸ˜Š</button>
                    <button onclick="addEmoji('â¤ï¸')" class="tool-btn">â¤ï¸</button>
                    <button onclick="addEmoji('ğŸ„')" class="tool-btn">ğŸ„</button>
                    <button onclick="addEmoji('ğŸ¥‚')" class="tool-btn">ğŸ¥‚</button>
                    <button onclick="addEmoji('ğŸ¶')" class="tool-btn">ğŸ¶</button>
                </div>
                <div class="toolbar">
                    <button id="btn-bold" class="tool-btn" onclick="execCmd('bold', 'btn-bold')"><i class="fas fa-bold"></i></button>
                    <button id="btn-italic" class="tool-btn" onclick="execCmd('italic', 'btn-italic')"><i class="fas fa-italic"></i></button>
                    <select onchange="document.execCommand('fontSize', false, this.value)" style="background:#222; color:white; border:1px solid var(--gold);">
                        <option value="3">M</option><option value="2">S</option><option value="5">L</option>
                    </select>
                    <input type="color" onchange="document.execCommand('foreColor', false, this.value)" style="width:30px; border:none; background:none;">
                    {% if current_user.role == 'owner' %}
                    <button class="tool-btn" onclick="socket.emit('clear_chat_request')" style="color:#ff4d4d; margin-left:auto;"><i class="fas fa-broom"></i></button>
                    {% endif %}
                </div>
                <div style="display:flex; gap:10px;">
                    <div id="chat-input" contenteditable="true" placeholder="Î ÎµÏ‚ ÎºÎ¬Ï„Î¹ ÏƒÏ„Î·Î½ Ï€Î±ÏÎ­Î±... ğŸ„"></div>
                    <button onclick="sendMessage()" style="background:var(--gold); border:none; padding:10px 20px; border-radius:15px; font-weight:bold; cursor:pointer;">Î£Î¤Î•Î™Î›Î•</button>
                </div>
            </div>
        </div>
        <div class="sidebar">
            <div style="color:var(--gold); font-weight:bold; margin-bottom:10px;">ONLINE</div>
            <div id="user-list-content"></div>
        </div>
    </div>

    <div id="setModal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--gold); text-align:center;">Î¡Î¥Î˜ÎœÎ™Î£Î•Î™Î£</h3>
            <label>Avatar URL:</label>
            <input type="text" id="new-avatar" style="width:95%; padding:8px; margin:10px 0; background:#222; border:1px solid #444; color:white;">
            <label>Î§ÏÏÎ¼Î± ÎŸÎ½ÏŒÎ¼Î±Ï„Î¿Ï‚:</label>
            <input type="color" id="new-color" style="width:100%; height:40px; margin:10px 0;">

            {% if current_user.role == 'owner' %}
            <div style="margin-top:20px; padding-top:15px; border-top:1px dashed var(--gold);">
                <p style="color:var(--gold); font-weight:bold; text-align:center;">Î¦ÎŸÎÎ¤ÎŸ Î£Î•Î›Î™Î”Î‘Î£</p>
                <input type="file" id="bg-upload" style="display:none;" onchange="handleFileUpload(this)">
                <button onclick="document.getElementById('bg-upload').click()" style="width:100%; padding:10px; background:var(--gold); font-weight:bold; border:none; border-radius:5px; cursor:pointer;">Î‘Î›Î›Î‘Î“Î— Î•Î™ÎšÎŸÎÎ‘Î£</button>
                <div style="margin-top:10px;">
                    <small>ÎœÎ­Î³ÎµÎ¸Î¿Ï‚:</small> <input type="range" id="size-slider" min="50" max="250" value="100" oninput="updateBg()" style="width:100%;">
                    <small>Î˜Î­ÏƒÎ·:</small> <input type="range" id="pos-slider" min="0" max="100" value="50" oninput="updateBg()" style="width:100%;">
                </div>
            </div>
            {% endif %}

            <button onclick="saveSettings()" style="width:100%; padding:12px; background:var(--gold); font-weight:bold; margin-top:20px; border-radius:10px; cursor:pointer;">Î‘Î ÎŸÎ˜Î—ÎšÎ•Î¥Î£Î—</button>
            <button onclick="document.getElementById('setModal').style.display='none'" style="width:100%; background:none; color:gray; border:none; margin-top:10px; cursor:pointer;">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
        </div>
    </div>

    <script id='sonic_js' data-port='8050' src='https://or.mysonicserver.com/cp/widgets.js?r=381'></script>
    <script>
        const socket = io();
        const chatInput = document.getElementById('chat-input');
        const chatBox = document.getElementById('chat-box');

        function execCmd(cmd, id) { document.execCommand(cmd, false, null); document.getElementById(id).classList.toggle('active'); chatInput.focus(); }
        function addEmoji(emoji) { chatInput.innerHTML += emoji; chatInput.focus(); }

        function sendMessage() {
            const content = chatInput.innerHTML.trim();
            if(content && content !== '<br>') {
                socket.emit('message', { content: content });
                chatInput.innerHTML = '';
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            }
        }

        chatInput.onkeypress = (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };

        socket.on('message', (msg) => {
            if(msg.content === 'CLEAN_EVENT') { chatBox.innerHTML = ''; return; }
            const div = document.createElement('div');
            div.className = 'message';
            div.innerHTML = `<b style="color:${msg.color}">${msg.display_name}</b><br><span>${msg.content}</span>`;
            chatBox.appendChild(div); chatBox.scrollTop = chatBox.scrollHeight;
        });

        // RADIO CONTROLS
        const radio = new Audio('https://or.mysonicserver.com:8050/;');
        document.getElementById('play-pause-btn').onclick = () => {
            if (radio.paused) { radio.play(); document.getElementById('play-icon').className='fas fa-pause'; }
            else { radio.pause(); document.getElementById('play-icon').className='fas fa-play'; }
        };
        document.getElementById('volume').oninput = (e) => radio.volume = e.target.value;

        // BG LOGIC
        function handleFileUpload(input) {
            const reader = new FileReader();
            reader.onload = (e) => socket.emit('admin_change_bg', { url: e.target.result });
            reader.readAsDataURL(input.files[0]);
        }
        function updateBg() {
            socket.emit('admin_bg_transform', { size: document.getElementById('size-slider').value, position: document.getElementById('pos-slider').value });
        }
        function applyBg(data) {
            if(data.url) document.body.style.backgroundImage = `url('${data.url}')`;
            document.body.style.backgroundSize = `${data.size || 100}% auto`;
            document.body.style.backgroundPosition = `center ${data.position || 50}%`;
        }
        socket.on('init_background', applyBg);
        socket.on('update_bg', applyBg);
        socket.on('update_bg_transform', applyBg);

        function saveSettings() {
            socket.emit('update_profile', { color: document.getElementById('new-color').value, avatar_url: document.getElementById('new-avatar').value });
            document.getElementById('setModal').style.display = 'none';
        }

        socket.on('user_list', (users) => {
            document.getElementById('user-list-content').innerHTML = users.map(u => `
                <div style="margin-bottom:10px;">
                    <img src="${u.avatar_url || 'https://ui-avatars.com/api/?name='+u.display_name}" style="width:45px; height:45px; border-radius:50%; border:2px solid ${u.color}; object-fit:cover;">
                    <div style="color:${u.color}; font-size:0.7em; font-weight:bold;">${u.display_name}</div>
                </div>`).join('');
        });
    </script>
</body>
</html>