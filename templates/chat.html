<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Parea - Live Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        :root { --gold: #D4AF37; --bg: #0d0d1a; --sidebar: #161625; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--bg); color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* HEADER & RADIO PLAYER */
        .header { background: #000; padding: 10px 20px; border-bottom: 2px solid var(--gold); display: flex; align-items: center; justify-content: space-between; height: 60px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .logo { font-family: 'Dancing Script'; color: var(--gold); font-size: 1.8em; }

        /* MAIN LAYOUT */
        .main { display: flex; flex: 1; overflow: hidden; }
        #chat-window { flex: 1; display: flex; flex-direction: column; background: rgba(0,0,0,0.3); position: relative; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        /* SIDEBAR ONLINE USERS */
        .sidebar { width: 260px; background: var(--sidebar); border-left: 1px solid #333; padding: 15px; display: flex; flex-direction: column; }
        .user-item { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding: 8px; border-radius: 10px; background: rgba(255,255,255,0.03); transition: 0.3s; }
        .user-item:hover { background: rgba(255,255,255,0.08); }
        .avatar { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--gold); object-fit: cover; }

        /* MESSAGE BUBBLES */
        .message { background: rgba(255,255,255,0.06); padding: 12px 18px; border-radius: 18px; max-width: 80%; align-self: flex-start; border: 1px solid rgba(255,255,255,0.1); animation: slideIn 0.3s ease-out; }
        .message.self { align-self: flex-end; background: rgba(212, 175, 55, 0.1); border-color: var(--gold); }
        .message img { max-width: 100%; border-radius: 12px; margin-top: 10px; border: 1px solid #444; }
        
        /* YOUTUBE EMBED */
        .yt-container { position: relative; padding-bottom: 56.25%; height: 0; margin-top: 10px; width: 100%; min-width: 300px; }
        .yt-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 12px; }

        /* INPUT AREA */
        .input-area { background: #1a1a2e; padding: 20px; border-top: 1px solid #333; box-shadow: 0 -5px 15px rgba(0,0,0,0.3); }
        .toolbar { display: flex; gap: 20px; margin-bottom: 10px; color: var(--gold); font-size: 1.2em; }
        .toolbar i { cursor: pointer; transition: 0.2s; }
        .toolbar i:hover { transform: scale(1.2); color: white; }
        .input-group { display: flex; gap: 12px; }
        input[type="text"] { flex: 1; padding: 14px 25px; border-radius: 30px; border: 1px solid #444; background: #0d0d1a; color: white; outline: none; font-size: 1em; }
        .send-btn { background: var(--gold); border: none; padding: 0 30px; border-radius: 30px; font-weight: bold; cursor: pointer; transition: 0.3s; color: #000; }
        .send-btn:hover { background: #fff; color: var(--gold); }

        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>

<div class="header">
    <div class="logo">Radio Parea Live</div>
    <div style="display:flex; align-items:center; gap:20px;">
        <audio id="radio-player" src="https://or.mysonicserver.com:8050/stream"></audio>
        <i class="fas fa-play-circle" id="play-btn" style="font-size: 2.2em; color: var(--gold); cursor:pointer;" onclick="toggleRadio()"></i>
        
        {% if role == 'owner' %}
        <i class="fas fa-trash-alt" style="color: #ff4d4d; cursor:pointer; font-size: 1.2em;" onclick="clearChat()" title="ŒöŒ±Œ∏Œ±œÅŒπœÉŒºœåœÇ Chat"></i>
        {% endif %}
        
        <a href="{{ url_for('logout') }}" style="color:white; text-decoration:none; font-size: 1.3em;"><i class="fas fa-sign-out-alt"></i></a>
    </div>
</div>

<div class="main">
    <div id="chat-window">
        <div id="messages"></div>
        
        <div class="input-area">
            <div class="toolbar">
                <i class="fas fa-bold" onclick="wrapText('<b>','</b>')"></i>
                <i class="fas fa-italic" onclick="wrapText('<i>','</i>')"></i>
                <i class="fas fa-link" onclick="insertLink()"></i>
                <i class="far fa-smile" onclick="insertEmoji('üòä')"></i>
            </div>
            <div class="input-group">
                <input type="text" id="chat-input" placeholder="ŒìœÅŒ¨œàŒµ Œ≠ŒΩŒ± ŒºŒÆŒΩœÖŒºŒ±..." autocomplete="off">
                <button class="send-btn" onclick="sendMessage()">Œ£œÑŒµŒØŒªŒµ</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <h3 style="color:var(--gold); font-size: 1.1em; border-bottom: 1px solid #333; padding-bottom: 12px; margin-top: 0;">Œ†Œ±œÅŒ≠Œ± Online</h3>
        <div id="user-list"></div>
    </div>
</div>

<script>
    const socket = io();
    const msgDiv = document.getElementById('messages');
    const input = document.getElementById('chat-input');
    const currentUser = "{{ display_name }}"; // ŒëœÄœå œÑŒø server.py

    // Media Parser (ŒïŒπŒ∫œåŒΩŒµœÇ & YouTube)
    function formatMessage(text) {
        // ŒïŒπŒ∫œåŒΩŒµœÇ
        const imgRegex = /(https?:\/\/[^\s]+(?:\.jpg|\.jpeg|\.png|\.gif))/gi;
        text = text.replace(imgRegex, '<img src="$1">');
        // YouTube
        const ytRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/g;
        text = text.replace(ytRegex, '<div class="yt-container"><iframe src="https://www.youtube.com/embed/$1" frameborder="0" allowfullscreen></iframe></div>');
        return text;
    }

    function sendMessage() {
        const content = input.value.trim();
        if (content) {
            socket.emit('message', { content: content });
            input.value = '';
        }
    }

    input.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

    socket.on('message', (data) => {
        const div = document.createElement('div');
        div.className = 'message' + (data.display_name === currentUser ? ' self' : '');
        div.innerHTML = `
            <div style="font-size: 0.85em; font-weight: bold; color: ${data.color}; margin-bottom: 4px;">
                ${data.display_name} <span style="font-weight: normal; opacity: 0.6; font-size: 0.9em;">(${data.role})</span>
            </div>
            <div class="text">${formatMessage(data.content)}</div>
        `;
        msgDiv.appendChild(div);
        msgDiv.scrollTop = msgDiv.scrollHeight;
    });

    socket.on('users_update', (users) => {
        const list = document.getElementById('user-list');
        list.innerHTML = users.map(u => `
            <div class="user-item">
                <img src="https://ui-avatars.com/api/?name=${u.display_name}&background=random" class="avatar">
                <span style="color: ${u.color}; font-weight: bold;">${u.display_name}</span>
            </div>
        `).join('');
    });

    socket.on('clear_chat_client', () => { msgDiv.innerHTML = ''; });

    function clearChat() { socket.emit('clear_chat_request'); }

    // Radio Player Logic
    const audio = document.getElementById('radio-player');
    const playBtn = document.getElementById('play-btn');
    function toggleRadio() {
        if (audio.paused) { audio.load(); audio.play(); playBtn.className = 'fas fa-pause-circle'; }
        else { audio.pause(); playBtn.className = 'fas fa-play-circle'; }
    }

    // Toolbar Helpers
    function wrapText(o, c) { input.value = input.value + o + c; input.focus(); }
    function insertEmoji(e) { input.value += e; input.focus(); }
    function insertLink() { const url = prompt("ŒïœÄŒπŒ∫œåŒªŒªŒ∑œÉŒ∑ URL:"); if(url) input.value += url; }
</script>
</body>
</html>