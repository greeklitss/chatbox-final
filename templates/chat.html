<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Parea - Live</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Orbitron:wght@700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        :root { --gold: #D4AF37; }
        body { 
            background: #000; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            background-size: cover !important; background-position: center center !important;
            background-repeat: no-repeat; background-attachment: fixed; transition: background 0.5s ease;
        }
        .header { background: rgba(0,0,0,0.85); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--gold); z-index: 1000; min-height: 110px; position: relative; }
        .disco-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .light { position: absolute; width: 200px; height: 200px; border-radius: 50%; filter: blur(80px); opacity: 0.3; animation: strobe 0.8s infinite alternate; }
        .l1 { top: 15%; left: 15%; background: #ff0000; }
        .l2 { bottom: 15%; right: 15%; background: #0000ff; animation-delay: 0.4s; }
        @keyframes strobe { from { opacity: 0.1; transform: scale(0.8); } to { opacity: 0.4; transform: scale(1.2); } }
        #dj_profile img { width: 80px !important; height: 80px !important; border-radius: 50% !important; border: 2px solid var(--gold) !important; object-fit: contain !important; background: #111; box-shadow: 0 0 15px rgba(212, 175, 55, 0.4); }
        #sonic_dj { font-family: 'Orbitron'; color: var(--gold); text-shadow: 0 0 10px red; font-weight: bold; }
        .player-container { background: rgba(212, 175, 55, 0.1); padding: 10px 20px; border-radius: 50px; border: 1px solid rgba(212, 175, 55, 0.3); display: flex; align-items: center; gap: 12px; z-index: 1005; }
        .main { display: flex; flex: 1; overflow: hidden; position: relative; z-index: 5; }
        #chat-window { flex: 1; display: flex; flex-direction: column; background: rgba(0,0,0,0.2); backdrop-filter: blur(4px); }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .message { background: rgba(30, 30, 30, 0.8); padding: 12px 15px; border-radius: 15px; border-left: 4px solid var(--gold); align-self: flex-start; max-width: 85%; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.5); margin-bottom: 5px; }
        .input-area { background: rgba(0,0,0,0.95); padding: 15px; border-top: 2px solid var(--gold); }
        .toolbar { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        #chat-input { flex: 1; padding: 12px; border-radius: 15px; border: 1px solid var(--gold); background: #111; color: white; outline: none; min-height: 40px; overflow-y: auto; }
        .tool-btn { background: rgba(212,175,55,0.1); border: 1px solid var(--gold); color: white; padding: 6px 12px; border-radius: 8px; cursor: pointer; text-decoration: none; font-size: 13px; display: inline-flex; align-items: center; justify-content: center; }
        .tool-btn:hover { background: var(--gold); color: black; }
        .sidebar { width: 180px; background: rgba(0,0,0,0.9); border-left: 2px solid var(--gold); padding-top: 15px; text-align: center; overflow-y: auto; }
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); }
        .modal-content { background: #111; margin: 10% auto; padding: 25px; border: 1px solid var(--gold); width: 320px; border-radius: 20px; color: white; }
    </style>
</head>
<body>
    <div class="disco-overlay"><div class="light l1"></div><div class="light l2"></div></div>

    <div class="header">
        <div style="display:flex; flex-direction:column; gap:8px; z-index:1010;">
            <button onclick="document.getElementById('setModal').style.display='block'" class="tool-btn"><i class="fas fa-cog"></i> Î¡Î¥Î˜ÎœÎ™Î£Î•Î™Î£</button>
            <a href="{{ url_for('logout') }}" class="tool-btn" style="color:#ff4d4d; border-color:#ff4d4d;"><i class="fas fa-power-off"></i> Î•ÎÎŸÎ”ÎŸÎ£</a>
        </div>
        
        <div class="player-container">
            <button id="play-pause-btn" style="background:var(--gold); border:none; width:45px; height:45px; border-radius:50%; cursor:pointer;"><i class="fas fa-play" id="play-icon"></i></button>
            <div style="text-align: left;">
                <div style="font-family:'Dancing Script'; font-size:1.6em; color:white;">Radio Parea <span id="sonic_dj"></span></div>
                <div id="sonic_title" style="font-size:0.85em; color:#ddd; font-weight:bold;">Î¦Î¿ÏÏ„ÏÎ½ÎµÎ¹...</div>
            </div>
        </div>

        <div style="text-align:center; z-index:1010;">
            <div id="dj_profile"></div>
            <div style="color:var(--gold); font-size:0.75em; margin-top:5px; font-weight:bold;">LISTENERS: <span id="sonic_listeners">0</span></div>
        </div>
    </div>

    <div class="main">
        <div id="chat-window">
            <div id="chat-box">
                {% for msg in history %}
                <div class="message">
                    <b style="color:{{msg.author.color}}">{{msg.author.display_name}}</b><br>
                    <span>{{msg.content|safe}}</span>
                </div>
                {% endfor %}
            </div>

            <div class="input-area">
                <div class="toolbar">
                    <button class="tool-btn" onclick="document.execCommand('bold')"><i class="fas fa-bold"></i></button>
                    <button class="tool-btn" onclick="document.execCommand('italic')"><i class="fas fa-italic"></i></button>
                    <input type="color" onchange="document.execCommand('foreColor', false, this.value)" style="width:25px; height:25px; border:none; cursor:pointer; background:none;">
                    <button onclick="addEmoji('ğŸ˜Š')" class="tool-btn">ğŸ˜Š</button>
                    <button onclick="addEmoji('ğŸ„')" class="tool-btn">ğŸ„</button>
                    <button onclick="addEmoji('ğŸ¶')" class="tool-btn">ğŸ¶</button>
                    <button onclick="addEmoji('ğŸ¥‚')" class="tool-btn">ğŸ¥‚</button>
                    {% if current_user.role == 'owner' %}
                    <button class="tool-btn" onclick="socket.emit('clear_chat_request')" style="color:#ff4d4d; margin-left:auto;"><i class="fas fa-broom"></i> Î£ÎšÎŸÎ¥Î Î‘</button>
                    {% endif %}
                </div>
                
                <div style="display:flex; gap:10px;">
                    <div id="chat-input" contenteditable="true"></div>
                    <button onclick="sendMessage()" style="background:var(--gold); border:none; padding:10px 25px; border-radius:15px; font-weight:bold; cursor:pointer;">Î£Î¤Î•Î™Î›Î•</button>
                </div>
            </div>
        </div>
        
        <div class="sidebar">
            <div style="color:var(--gold); font-weight:bold; margin-bottom:12px; font-size:0.9em;">ONLINE USERS</div>
            <div id="user-list-content"></div>
        </div>
    </div>

    <div id="setModal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--gold); text-align:center; margin-top:0;">Î Î¡ÎŸÎ¦Î™Î›</h3>
            <label>Avatar URL:</label>
            <input type="text" id="new-avatar" value="{{ current_user.avatar_url or '' }}" style="width:100%; padding:8px; margin:10px 0; background:#222; border:1px solid #444; color:white;">
            
            <label>Î§ÏÏÎ¼Î± ÎŸÎ½ÏŒÎ¼Î±Ï„Î¿Ï‚:</label>
            <input type="color" id="new-color" value="{{ current_user.color }}" style="width:100%; height:40px; margin:10px 0; border:none; cursor:pointer; background:none;">

            <button onclick="saveSettings()" style="width:100%; padding:12px; background:var(--gold); color:black; font-weight:bold; margin-top:20px; border-radius:10px; border:none; cursor:pointer;">Î‘Î ÎŸÎ˜Î—ÎšÎ•Î¥Î£Î—</button>
            <button onclick="document.getElementById('setModal').style.display='none'" style="width:100%; background:none; color:gray; border:none; margin-top:10px; cursor:pointer;">Î†ÎºÏ…ÏÎ¿</button>
        </div>
    </div>

    <script id='sonic_js' data-port='8050' src='https://or.mysonicserver.com/cp/widgets.js?r=381'></script>

    <script>
        const socket = io();
        const chatInput = document.getElementById('chat-input');
        const chatBox = document.getElementById('chat-box');

        function addEmoji(emoji) { chatInput.innerHTML += emoji; chatInput.focus(); }

        function sendMessage() {
            const content = chatInput.innerHTML.trim();
            if(content && content !== '<br>') {
                socket.emit('message', { content: content });
                chatInput.innerHTML = '';
            }
        }

        chatInput.onkeypress = (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };

        // Î›Î®ÏˆÎ· Î¼Î·Î½Ï…Î¼Î¬Ï„Ï‰Î½ ÎºÎ±Î¹ Î£ÎºÎ¿ÏÏ€Î±Ï‚
        socket.on('message', (msg) => {
            const div = document.createElement('div');
            div.className = 'message';
            div.innerHTML = `<b style="color:${msg.color}">${msg.display_name}</b><br><span>${msg.content}</span>`;
            chatBox.appendChild(div); 
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        socket.on('clear_chat_client', () => {
            chatBox.innerHTML = '';
        });

        // Î›Î®ÏˆÎ· Online Ï‡ÏÎ·ÏƒÏ„ÏÎ½ (Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼Î­Î½Î¿ Î¼Îµ Ï„Î¿Î½ server)
        socket.on('users_update', (users) => {
            console.log("Users update received:", users);
            document.getElementById('user-list-content').innerHTML = users.map(u => `
                <div style="margin-bottom:12px; display: flex; flex-direction: column; align-items: center;">
                    <img src="${u.avatar_url || 'https://ui-avatars.com/api/?name='+u.display_name}" style="width:45px; height:45px; border-radius:50%; border:2px solid ${u.color}; object-fit:cover;">
                    <div style="color:${u.color}; font-size:0.75em; font-weight:bold;">${u.display_name}</div>
                </div>`).join('');
        });

        // RADIO PLAYER
        const radio = new Audio('https://or.mysonicserver.com:8050/;');
        document.getElementById('play-pause-btn').onclick = () => {
            if (radio.paused) { radio.play(); document.getElementById('play-icon').className='fas fa-pause'; }
            else { radio.pause(); document.getElementById('play-icon').className='fas fa-play'; }
        };

        function saveSettings() {
            socket.emit('update_profile', { 
                new_avatar: document.getElementById('new-avatar').value 
            });
            document.getElementById('setModal').style.display = 'none';
        }
    </script>
</body>
</html>